{% extends "base.html" %}
{% block title %}Data Export Hub Â· Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">ğŸ“Š Data Export Hub</h1>
        <p>Extract, analyze, and export payroll data across all datasets with custom date ranges and filters.</p>
    </div>
</section>

<!-- Export Quick Access Cards -->
<section class="export-cards-grid">
    <div class="export-card export-card--payouts">
        <div class="export-card__icon">ğŸ’°</div>
        <div class="export-card__content">
            <h3 class="export-card__title">Payroll Payouts</h3>
            <p class="export-card__description">All scheduled payments from payroll cycles with status tracking</p>
        </div>
        <label class="export-card__checkbox">
            <input type="checkbox" name="datasets" value="payouts" checked data-card="payouts">
            <span class="export-card__checkbox-label">Include</span>
        </label>
    </div>
    
    <div class="export-card export-card--adhoc">
        <div class="export-card__icon">ğŸ“</div>
        <div class="export-card__content">
            <h3 class="export-card__title">Ad Hoc Payments</h3>
            <p class="export-card__description">One-off transactions and special payments outside regular cycles</p>
        </div>
        <label class="export-card__checkbox">
            <input type="checkbox" name="datasets" value="adhoc" data-card="adhoc">
            <span class="export-card__checkbox-label">Include</span>
        </label>
    </div>
    
    <div class="export-card export-card--adjustments">
        <div class="export-card__icon">ğŸ“ˆ</div>
        <div class="export-card__content">
            <h3 class="export-card__title">Compensation Adjustments</h3>
            <p class="export-card__description">Historical record of model compensation rate changes</p>
        </div>
        <label class="export-card__checkbox">
            <input type="checkbox" name="datasets" value="adjustments" data-card="adjustments">
            <span class="export-card__checkbox-label">Include</span>
        </label>
    </div>
    
    <div class="export-card export-card--runs">
        <div class="export-card__icon">ğŸ—“ï¸</div>
        <div class="export-card__content">
            <h3 class="export-card__title">Schedule Cycles</h3>
            <p class="export-card__description">Complete payroll cycle history with summary totals</p>
        </div>
        <label class="export-card__checkbox">
            <input type="checkbox" name="datasets" value="runs" data-card="runs">
            <span class="export-card__checkbox-label">Include</span>
        </label>
    </div>
</section>

<!-- Compact Inline Filter Card -->
<section class="analytics-filter-card">
    <form id="analytics-form" class="analytics-filter-form">
        <div class="analytics-filter-form__row">
            <div class="analytics-filter-form__label">
                <span class="analytics-filter-form__icon">ğŸ“…</span>
                <span>Date Range</span>
            </div>
            <div class="analytics-filter-form__inputs">
                <input id="analytics-start" name="start" type="date" value="{{ default_start }}" required class="analytics-filter-form__date" aria-label="Start Date">
                <span class="analytics-filter-form__arrow">â†’</span>
                <input id="analytics-end" name="end" type="date" value="{{ default_end }}" required class="analytics-filter-form__date" aria-label="End Date">
            </div>
            <div class="analytics-filter-form__quick" id="analytics-quick-ranges">
                <button class="analytics-quick-chip" type="button" data-range="past_7_days" data-days="7" aria-label="Last 7 days">7d</button>
                <button class="analytics-quick-chip" type="button" data-range="past_30_days" data-days="30" aria-label="Last 30 days">30d</button>
                <button class="analytics-quick-chip" type="button" data-range="past_3_months" data-months="3" aria-label="Last 3 months">3m</button>
                <button class="analytics-quick-chip" type="button" data-range="past_6_months" data-months="6" aria-label="Last 6 months">6m</button>
                <button class="analytics-quick-chip" type="button" data-range="past_1_year" data-months="12" aria-label="Last year">1y</button>
            </div>
            <div class="analytics-filter-form__actions">
                <button class="button button--primary" type="submit">
                    <span class="button__icon">ğŸ”</span>
                    <span>Generate</span>
                </button>
                <button class="button button--ghost" type="button" id="analytics-reset" aria-label="Reset filters">
                    <span>Reset</span>
                </button>
            </div>
        </div>
    </form>
</section>

<!-- Export Summary -->
<section class="export-summary-card" id="analytics-summary" hidden>
    <div class="export-summary-card__header">
        <div>
            <h2 class="export-summary-card__title">Export Summary</h2>
            <p class="export-summary-card__subtitle" id="analytics-range"></p>
        </div>
        <button class="button export button--compact" id="download-excel" type="button">
            <span class="button__icon">ğŸ“Š</span>
            <span>Export to Excel</span>
        </button>
    </div>
    
    <div class="export-summary-card__metrics">
        <div class="export-metric export-metric--datasets">
            <span class="export-metric__icon">ğŸ“¦</span>
            <div class="export-metric__content">
                <span class="export-metric__label">Datasets</span>
                <span class="export-metric__value" id="analytics-datasets"></span>
            </div>
        </div>
        
        <div class="export-metric export-metric--records">
            <span class="export-metric__icon">ğŸ“‹</span>
            <div class="export-metric__content">
                <span class="export-metric__label">Total Records</span>
                <span class="export-metric__value" id="analytics-counts"></span>
            </div>
        </div>
        
        <div class="export-metric export-metric--paid" id="analytics-totals" hidden>
            <span class="export-metric__icon">âœ…</span>
            <div class="export-metric__content">
                <span class="export-metric__label">Paid Amount</span>
                <span class="export-metric__value export-metric__value--success" id="analytics-paid-total">$0.00</span>
            </div>
        </div>
        
        <div class="export-metric export-metric--unpaid" id="analytics-unpaid-wrapper" hidden>
            <span class="export-metric__icon">â³</span>
            <div class="export-metric__content">
                <span class="export-metric__label">Outstanding</span>
                <span class="export-metric__value export-metric__value--warning" id="analytics-unpaid-total">$0.00</span>
            </div>
        </div>
    </div>
</section>

<!-- Results Section -->
<section class="card" id="analytics-results">
    <div class="section-heading">
        <h2><span class="section-icon">ğŸ“Š</span> Export Results</h2>
    </div>
    <div id="analytics-placeholder" class="export-placeholder">
        <div class="export-placeholder__icon">ğŸ“Š</div>
        <h3 class="export-placeholder__title">Ready to Export</h3>
        <p class="export-placeholder__message">Select datasets above and click "Generate Export" to retrieve your data</p>
    </div>
    <div id="analytics-tables"></div>
</section>

<script>
(function() {
    const form = document.getElementById('analytics-form');
    const resetButton = document.getElementById('analytics-reset');
    const downloadButton = document.getElementById('download-excel');
    const placeholder = document.getElementById('analytics-placeholder');
    const summaryCard = document.getElementById('analytics-summary');
    const rangeField = document.getElementById('analytics-range');
    const datasetsField = document.getElementById('analytics-datasets');
    const countsField = document.getElementById('analytics-counts');
    const paidField = document.getElementById('analytics-paid-total');
    const unpaidField = document.getElementById('analytics-unpaid-total');
    const totalsRow = document.getElementById('analytics-totals');
    const unpaidWrapper = document.getElementById('analytics-unpaid-wrapper');
    const tablesContainer = document.getElementById('analytics-tables');
    const quickRangeContainer = document.getElementById('analytics-quick-ranges');
    const startInput = document.getElementById('analytics-start');
    const endInput = document.getElementById('analytics-end');
    let activeQuickRange = null;
    let lastExportData = null;

    function formatAmount(value) {
        return '$' + Number(value || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function updateCardStates() {
        const checkboxes = document.querySelectorAll('.export-card__checkbox input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            const card = checkbox.closest('.export-card');
            if (checkbox.checked) {
                card.classList.add('export-card--selected');
            } else {
                card.classList.remove('export-card--selected');
            }
        });
    }
    
    function downloadExcel() {
        if (!lastExportData) {
            alert('No export data available. Please generate an export first.');
            return;
        }
        
        const { results } = lastExportData;
        let csvContent = '';
        
        // Generate CSV for each dataset
        for (const [datasetName, rows] of Object.entries(results)) {
            if (rows.length === 0) continue;
            
            // Add dataset header
            csvContent += `\n${datasetName.toUpperCase()}\n`;
            
            // Add column headers
            const headers = Object.keys(rows[0]);
            csvContent += headers.join(',') + '\n';
            
            // Add data rows
            rows.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] ?? '';
                    // Escape quotes and wrap in quotes if contains comma or quote
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += values.join(',') + '\n';
            });
            
            csvContent += '\n';
        }
        
        // Create and download CSV file (Excel can open CSV files)
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `payroll-export-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function daysInMonth(year, monthIndex) {
        return new Date(year, monthIndex + 1, 0).getDate();
    }

    function subtractMonths(date, months) {
        let year = date.getFullYear();
        let monthIndex = date.getMonth() - months;
        const day = date.getDate();
        while (monthIndex < 0) {
            monthIndex += 12;
            year -= 1;
        }
        const maxDay = daysInMonth(year, monthIndex);
        const adjustedDay = Math.min(day, maxDay);
        return new Date(year, monthIndex, adjustedDay);
    }

    function clearQuickRangeState() {
        activeQuickRange = null;
        if (!quickRangeContainer) {
            return;
        }
        quickRangeContainer.querySelectorAll('.analytics-quick-chip').forEach((button) => {
            button.classList.remove('analytics-quick-chip--active');
        });
    }

    function setQuickRange(button) {
        const today = new Date();
        let startDate = null;
        const days = button.getAttribute('data-days');
        const months = button.getAttribute('data-months');
        if (days) {
            const dayCount = parseInt(days, 10);
            startDate = new Date(today);
            startDate.setDate(today.getDate() - (dayCount - 1));
        } else if (months) {
            const monthCount = parseInt(months, 10);
            startDate = subtractMonths(today, monthCount);
        }
        if (!startDate) {
            return;
        }
        startInput.value = formatDate(startDate);
        endInput.value = formatDate(today);
        activeQuickRange = button.getAttribute('data-range');
        if (quickRangeContainer) {
            quickRangeContainer.querySelectorAll('.analytics-quick-chip').forEach((btn) => {
                if (btn === button) {
                    btn.classList.add('analytics-quick-chip--active');
                } else {
                    btn.classList.remove('analytics-quick-chip--active');
                }
            });
        }
    }

    function serializeForm() {
        const params = new URLSearchParams();
        const start = startInput.value;
        const end = endInput.value;
        params.set('start', start);
        params.set('end', end);
        const checkboxes = document.querySelectorAll('.export-card__checkbox input[type="checkbox"]:checked');
        const datasets = Array.from(checkboxes).map(cb => cb.value);
        if (datasets.length) {
            params.set('datasets', datasets.join(','));
        }
        return params;
    }

    function renderTable(title, rows, key) {
        const icons = { payouts: 'ğŸ’°', adhoc: 'ğŸ“', adjustments: 'ğŸ“ˆ', runs: 'ğŸ—“ï¸' };
        const icon = icons[key] || 'ğŸ“Š';
        
        if (!rows.length) {
            return `<div class="export-dataset">\n<div class="export-dataset__header">\n<h3 class="export-dataset__title"><span class="export-dataset__icon">${icon}</span>${title}</h3>\n<span class="export-dataset__count">0 records</span>\n</div>\n<div class="export-dataset__empty">No records found in selected date range</div>\n</div>`;
        }
        
        const columns = Object.keys(rows[0]);
        const header = columns.map((column) => `<th>${column.replace(/_/g, ' ')}</th>`).join('');
        const body = rows.map((row) => {
            const cells = columns.map((column) => `<td>${row[column] ?? ''}</td>`).join('');
            return `<tr>${cells}</tr>`;
        }).join('');
        
        return `<div class="export-dataset">\n<div class="export-dataset__header">\n<h3 class="export-dataset__title"><span class="export-dataset__icon">${icon}</span>${title}</h3>\n<span class="export-dataset__count">${rows.length.toLocaleString()} record${rows.length !== 1 ? 's' : ''}</span>\n</div>\n<div class="data-table-wrapper">\n<table class="data-table">\n<thead><tr>${header}</tr></thead>\n<tbody>${body}</tbody>\n</table>\n</div>\n</div>`;
    }

    async function runAnalytics() {
        placeholder.innerHTML = '<div class="export-placeholder__icon">â³</div><h3 class="export-placeholder__title">Generating Export...</h3><p class="export-placeholder__message">Fetching data from selected datasets</p>';
        placeholder.hidden = false;
        tablesContainer.innerHTML = '';
        summaryCard.hidden = true;

        const params = serializeForm();
        try {
            const response = await fetch(`/analytics/data?${params.toString()}`);
            if (!response.ok) {
                throw new Error(`Request failed with status ${response.status}`);
            }
            const payload = await response.json();
            lastExportData = payload;
            const { meta, results } = payload;

            rangeField.textContent = `${meta.start} â†’ ${meta.end}`;
            
            const datasetLabels = meta.datasets.map(key => {
                const labels = { payouts: 'Payouts', adhoc: 'Ad Hoc', adjustments: 'Adjustments', runs: 'Cycles' };
                return labels[key] || key;
            });
            datasetsField.textContent = datasetLabels.join(', ') || 'None';
            
            const totalCount = Object.values(meta.counts).reduce((sum, val) => sum + val, 0);
            countsField.textContent = totalCount.toLocaleString();
            
            const totals = (meta && meta.totals) || {};
            paidField.textContent = formatAmount(totals.paid);
            unpaidField.textContent = formatAmount(totals.unpaid);
            
            if (totalsRow && unpaidWrapper) {
                const hasPaymentData = Object.keys(results).some(key => key === 'payouts' || key === 'adhoc');
                totalsRow.hidden = !hasPaymentData;
                unpaidWrapper.hidden = !hasPaymentData;
            }
            
            summaryCard.hidden = false;

            const fragments = [];
            for (const [key, rows] of Object.entries(results)) {
                const title = key.replace(/_/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase());
                fragments.push(renderTable(title, rows, key));
            }
            tablesContainer.innerHTML = fragments.join('');
            placeholder.hidden = true;
            
            if (!fragments.length) {
                placeholder.innerHTML = '<div class="export-placeholder__icon">ğŸ“­</div><h3 class="export-placeholder__title">No Data Found</h3><p class="export-placeholder__message">No records match your selected filters and date range</p>';
                placeholder.hidden = false;
            }
        } catch (error) {
            placeholder.innerHTML = `<div class="export-placeholder__icon">âš ï¸</div><h3 class="export-placeholder__title">Export Failed</h3><p class="export-placeholder__message">${error.message || 'Unable to fetch analytics data'}</p>`;
            placeholder.hidden = false;
            summaryCard.hidden = true;
            tablesContainer.innerHTML = '';
            lastExportData = null;
        }
    }

    function handleFormSubmit(event) {
        event.preventDefault();
        runAnalytics();
    }

    function resetFilters() {
        startInput.value = '{{ default_start }}';
        endInput.value = '{{ default_end }}';
        document.querySelectorAll('.export-card__checkbox input[type="checkbox"]').forEach((input) => {
            input.checked = input.value === 'payouts';
        });
        updateCardStates();
        placeholder.innerHTML = '<div class="export-placeholder__icon">ğŸ“Š</div><h3 class="export-placeholder__title">Ready to Export</h3><p class="export-placeholder__message">Select datasets above and click "Generate Export" to retrieve your data</p>';
        placeholder.hidden = false;
        summaryCard.hidden = true;
        tablesContainer.innerHTML = '';
        lastExportData = null;
        clearQuickRangeState();
    }

    form.addEventListener('submit', handleFormSubmit);
    resetButton.addEventListener('click', resetFilters);
    downloadButton.addEventListener('click', downloadExcel);
    
    document.querySelectorAll('.export-card__checkbox input[type="checkbox"]').forEach((checkbox) => {
        checkbox.addEventListener('change', updateCardStates);
    });
    
    if (quickRangeContainer) {
        quickRangeContainer.querySelectorAll('.analytics-quick-chip').forEach((button) => {
            button.addEventListener('click', () => {
                setQuickRange(button);
                runAnalytics();
            });
        });
    }
    
    if (startInput) {
        startInput.addEventListener('input', clearQuickRangeState);
    }
    if (endInput) {
        endInput.addEventListener('input', clearQuickRangeState);
    }
    
    // Initialize card states
    updateCardStates();
})();
</script>
{% endblock %}
