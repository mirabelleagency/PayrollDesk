{% extends "base.html" %}
{% block title %}Payroll Cycle {{ run.id }} ¬∑ Payroll Desk{% endblock %}
{% block content %}

<!-- Page Header -->
<section class="page-header" style="margin-bottom: 24px;">
    <div>
    <h1 class="page-title">üí≥ {{ run.cycle_display }} Payroll Cycle</h1>
        <p style="color: #94a3b8; margin: 8px 0 0 0;">
            <span>Cycle #{{ run.id }}</span>
            <span style="margin: 0 8px; color: #475569;">‚Ä¢</span>
            <span>Generated {{ run.created_at|display_date }}</span>
            <span style="margin: 0 8px; color: #475569;">‚Ä¢</span>
            <span>Currency: {{ run.currency }}</span>
        </p>
    </div>
    <div class="header-actions">
        <a class="button secondary" href="/schedules">
            <span>‚Üê Back to Cycles</span>
        </a>
        <div class="export-controls" style="display: flex; gap: 8px;">
            {# CSV export removed ‚Äî Excel will export the current status filter #}
            <a id="export-excel" data-base-href="/schedules/{{ run.id }}/download/schedule_excel" class="button button--primary" href="/schedules/{{ run.id }}/download/schedule_excel{% if filters.status %}?status={{ filters.status }}{% endif %}">
                <span>üì•</span>
                <span>Export Excel</span>
            </a>
        </div>
    </div>
</section>

<!-- Validation Alerts (if any) -->
{% if validations|length > 0 %}
<section class="alert-banner alert-banner--warning" style="margin-bottom: 24px;">
    <div class="alert-banner__icon">‚ö†Ô∏è</div>
    <div class="alert-banner__content">
        <div class="alert-banner__title">{{ validations|length }} Validation Issue{{ 's' if validations|length != 1 else '' }}</div>
        <div class="alert-banner__message">Review issues before processing payments</div>
    </div>
    <button class="alert-banner__action" onclick="toggleValidation()">
        <span id="validation-toggle-text">Show Details</span>
    </button>
</section>
{% endif %}

<!-- Hero Metrics Dashboard -->
<section class="schedule-metrics-dashboard">
    <div class="schedule-metric schedule-metric--primary">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">‚úÖ</span>
            <span class="schedule-metric__label">Paid This Cycle</span>
        </div>
        <div class="schedule-metric__value">{{ run.currency }} {{ summary.paid_total|money }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">{{ summary.paid_models }} models</span>
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item">{{ status_counts.get('paid', 0) }} payments</span>
        </div>
    </div>

    <div class="schedule-metric schedule-metric--warning">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">‚è≥</span>
            <span class="schedule-metric__label">Unpaid This Cycle</span>
        </div>
        <div class="schedule-metric__value">{{ run.currency }} {{ summary.unpaid_total|money }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">{{ status_counts.get('not_paid', 0) }} pending</span>
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item">{{ status_counts.get('on_hold', 0) }} on hold</span>
        </div>
    </div>

    <div class="schedule-metric schedule-metric--danger {% if overdue_count > 0 %}schedule-metric--alert{% endif %}">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">üö®</span>
            <span class="schedule-metric__label">Overdue</span>
        </div>
        <div class="schedule-metric__value">{{ overdue_count }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">{{ run.currency }} {{ overdue_amount|money }}</span>
            {% if overdue_count > 0 %}
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item" style="color: #ef4444;">Action needed</span>
            {% else %}
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item">All current</span>
            {% endif %}
        </div>
    </div>

    <div class="schedule-metric schedule-metric--success">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">üí∞</span>
            <span class="schedule-metric__label">Lifetime Paid</span>
        </div>
        <div class="schedule-metric__value">{{ run.currency }} {{ summary.overall_paid|money }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">All-time total</span>
        </div>
    </div>

    <div class="schedule-metric schedule-metric--neutral">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">üìä</span>
            <span class="schedule-metric__label">Frequency Mix</span>
        </div>
        <div class="schedule-metric__value schedule-metric__value--compact">{{ payouts|length }}</div>
        <div class="schedule-metric__breakdown">
            {% for name, count in frequency_counts.items() %}
                <span class="schedule-metric__item">{{ name|title }}: {{ count }}</span>
                {% if not loop.last %}<span class="schedule-metric__divider">¬∑</span>{% endif %}
            {% else %}
                <span class="schedule-metric__item">No data</span>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Payouts Section -->
<section class="card" style="margin-top: 32px;">
    <div class="section-heading">
        <div>
            <h2><span class="section-icon">üìã</span> Payment Schedule</h2>
            <p style="color: #94a3b8; margin: 4px 0 0 0;">{{ payouts|length }} payment{{ 's' if payouts|length != 1 else '' }} in this cycle</p>
        </div>
    </div>

    <!-- Compact Filter Toolbar -->
    <div class="schedule-filter-toolbar">
        <div class="schedule-filter-toolbar__search">
            <input type="text" id="quick-search" placeholder="üîç Search by code, name..." 
                   onkeyup="filterPayoutTable()" 
                   class="filter-search-input">
        </div>
        
        <form class="schedule-filter-toolbar__filters" method="get" action="/schedules/{{ run.id }}">
            <input type="hidden" name="q" id="filter-q-hidden" value="{{ request.query_params.get('q','') if request and request.query_params else '' }}">
            <div class="filter-group-inline">
                <label for="filter-status">Status</label>
                <select id="filter-status" name="status" onchange="this.form.submit()" class="filter-select">
                    <option value="">All</option>
                    {% for option in status_options %}
                        <option value="{{ option }}" {% if filters.status == option %}selected{% endif %}>{{ option.replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>

            {# Code filter removed for single-run schedule view to simplify toolbar #}

            <div class="filter-group-inline">
                <label for="filter-frequency">Frequency</label>
                <select id="filter-frequency" name="frequency" onchange="this.form.submit()" class="filter-select">
                    <option value="">All</option>
                    {% for value in frequency_options %}
                        <option value="{{ value }}" {% if filters.frequency == value %}selected{% endif %}>{{ value|title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group-inline">
                <label for="filter-method">Method</label>
                <select id="filter-method" name="payment_method" onchange="this.form.submit()" class="filter-select">
                    <option value="">All</option>
                    {% for value in payment_methods %}
                        <option value="{{ value }}" {% if filters.payment_method == value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group-inline">
                <label for="filter-pay-date">Pay Date</label>
                <select id="filter-pay-date" name="pay_date" onchange="this.form.submit()" class="filter-select">
                    <option value="">All dates</option>
                    {% for option in pay_date_options %}
                        <option value="{{ option.value }}" {% if filters.pay_date == option.value %}selected{% endif %} {% if not option.available %}disabled{% endif %}>{{ option.label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            {% if filters.code or filters.status or filters.frequency or filters.payment_method or filters.pay_date %}
            <a class="filter-clear-button" href="/schedules/{{ run.id }}">
                <span>‚úï</span>
                <span>Clear</span>
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Status Filter Chips -->
    <div class="status-filter-chips" style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="status-chip-filter {% if not filters.status %}status-chip-filter--active{% endif %}" 
            onclick="filterByStatus('')" type="button" data-status-value="">
            All ({{ payouts|length }})
        </button>
        {% if overdue_count > 0 %}
        <button class="status-chip-filter status-chip-filter--overdue" 
            onclick="filterByOverdue()" type="button" data-status-value="overdue">
            üö® Overdue ({{ overdue_count }})
        </button>
        {% endif %}
        {% for option in status_options %}
        <button class="status-chip-filter status-chip-filter--{{ option }} {% if filters.status == option %}status-chip-filter--active{% endif %}" 
            onclick="filterByStatus('{{ option }}')" type="button" data-status-value="{{ option }}">
            {{ option.replace('_', ' ')|title }} ({{ status_counts.get(option, 0) }})
        </button>
        {% endfor %}
    </div>

    <div class="filter-toolbar__stats" id="filter-stats" style="margin-top: 16px; padding: 12px 0; border-top: 1px solid rgba(148, 163, 184, 0.08); color: #94a3b8; font-size: 14px;">
        <span>Showing <strong id="visible-count">{{ payouts|length }}</strong> of <strong>{{ payouts|length }}</strong> payments</span>
    </div>
    
    <!-- Modern Payouts Table -->
    <div class="data-table-wrapper" style="margin-top: 24px;">
        <table class="data-table schedule-payouts-table" id="payouts-table">
            <thead>
                <tr>
                    <th data-column-key="select" class="column-select" scope="col" data-draggable="false">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)" title="Select All">
                    </th>
                    <th data-column-key="pay_date" class="column-pay_date" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('pay_date')">
                        <span class="column-label">Pay Date</span>
                    </th>
                    <th data-column-key="code" class="column-code" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('code')">
                        <span class="column-label">Code</span>
                    </th>
                    <th data-column-key="working_name" class="column-working_name" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('working_name')">
                        <span class="column-label">Working Name</span>
                    </th>
                    <th data-column-key="payment_method" class="column-payment_method" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('payment_method')">
                        <span class="column-label">Method</span>
                    </th>
                    <th data-column-key="frequency" class="column-frequency" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('frequency')">
                        <span class="column-label">Frequency</span>
                    </th>
                    <th data-column-key="amount" class="column-amount" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('amount')">
                        <span class="column-label">Amount</span>
                    </th>
                    <th data-column-key="deductions" class="column-deductions" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('deductions')">
                        <span class="column-label">Deductions</span>
                    </th>
                    <th data-column-key="status" class="column-status" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('status')">
                        <span class="column-label">Status</span>
                    </th>
                    <th data-column-key="notes" class="column-notes" data-sortable="true" data-draggable="true" draggable="true" onclick="sortTable('notes')">
                        <span class="column-label">Notes</span>
                    </th>
                    <th data-column-key="actions" class="column-actions" data-draggable="true" draggable="true">
                        <span class="column-label">Quick Actions</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for payout in payouts %}
                {% set is_overdue = payout.pay_date and payout.pay_date < today and payout.status in ['not_paid', 'on_hold'] %}
                <tr class="payout-row payout-row--{{ payout.status }} {% if is_overdue %}payout-row--overdue{% endif %}" 
                    data-payout-id="{{ payout.id }}"
                    data-code="{{ payout.code|lower }}"
                    data-name="{{ (payout.working_name or '')|lower }}"
                    data-status="{{ payout.status }}"
                    data-is-overdue="{{ 'true' if is_overdue else 'false' }}"
                    data-amount="{{ payout.amount or 0 }}">
                    <td data-column-key="select" class="column-select" style="text-align: center;">
                        <input type="checkbox" class="payout-checkbox" value="{{ payout.id }}" onchange="updateBulkSection()" title="Select payout {{ payout.code }}">
                    </td>
                    <td data-column-key="pay_date" class="column-pay_date" style="white-space: nowrap;">
                        <strong>{{ payout.pay_date|display_date }}</strong>
                        {% if is_overdue %}
                        <span class="overdue-badge" title="Payment is overdue">üö®</span>
                        {% endif %}
                    </td>
                    <td data-column-key="code" class="column-code">
                        <span style="font-weight: 600; color: #60a5fa;">{{ payout.code }}</span>
                    </td>
                    <td data-column-key="working_name" class="column-working_name">{{ payout.working_name or '‚Äî' }}</td>
                    <td data-column-key="payment_method" class="column-payment_method">{{ payout.payment_method or '‚Äî' }}</td>
                    <td data-column-key="frequency" class="column-frequency">
                        <span class="frequency-badge frequency-badge--{{ payout.payment_frequency }}">
                            {{ payout.payment_frequency|title if payout.payment_frequency else '‚Äî' }}
                        </span>
                    </td>
                    <td data-column-key="amount" class="column-amount">
                        <strong style="font-size: 15px;">{{ run.currency }} {{ payout.amount|money }}</strong>
                    </td>
                    <td data-column-key="deductions" class="column-deductions" style="text-align: center;">
                        {% set deduction = advance_allocations.get(payout.id, 0) %}
                        {% if deduction > 0 %}
                        <span title="Cash advance deduction for this payout" style="color: #ef4444; font-weight: 600;">
                            -{{ run.currency }} {{ deduction|money }}
                        </span>
                        {% else %}
                        <span style="color: #475569;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td data-column-key="status" class="column-status" style="text-align: center;">
                        {% set variant = (
                            'success' if payout.status == 'paid' else (
                            'info' if payout.status == 'approved' else (
                            'warning' if payout.status == 'not_paid' else (
                            'danger' if payout.status == 'on_hold' else 'neutral')))) %}
                        <span class="status-chip status-chip--{{ variant }}">
                            {{ payout.status.replace('_', ' ')|title }}
                        </span>
                        {% if is_overdue %}
                        <span class="overdue-label">OVERDUE</span>
                        {% endif %}
                    </td>
                    <td data-column-key="notes" class="column-notes payout-note-cell">
                        {% if payout.notes %}
                        <span class="payout-note-text" title="{{ payout.notes }}">{{ payout.notes|replace('\n', ' ') }}</span>
                        {% else %}
                        <span class="payout-note-text payout-note-text--empty">‚Äî</span>
                        {% endif %}
                    </td>
                    <td data-column-key="actions" class="column-actions">
                        <div style="display: flex; gap: 6px; align-items: center;">
                            {% if payout.status != 'paid' %}
                <button class="action-button action-button--success js-quick-update" 
                    data-payout-id="{{ payout.id }}" data-action="paid"
                    title="Mark as Paid">
                                ‚úì
                            </button>
                            {% else %}
                <button class="action-button action-button--neutral js-quick-update" 
                    data-payout-id="{{ payout.id }}" data-action="not_paid"
                    title="Unmark Paid">
                                ‚Ü∫
                            </button>
                            {% endif %}
                            {% if payout.status != 'approved' %}
                <button class="action-button action-button--primary js-quick-update" 
                    data-payout-id="{{ payout.id }}" data-action="approved"
                    title="Mark Approved">
                                ‚úî
                            </button>
                            {% else %}
                <button class="action-button action-button--neutral js-quick-update" 
                    data-payout-id="{{ payout.id }}" data-action="not_paid"
                    title="Unmark Approved">
                                ‚Ü∫
                            </button>
                            {% endif %}
                            {% if payout.status != 'on_hold' %}
                <button class="action-button action-button--warning js-quick-update" 
                    data-payout-id="{{ payout.id }}" data-action="on_hold"
                    title="Put On Hold">
                                ‚è∏
                            </button>
                            {% else %}
                <button class="action-button action-button--neutral js-quick-update" 
                    data-payout-id="{{ payout.id }}" data-action="not_paid"
                    title="Remove Hold">
                                ‚ñ∂
                            </button>
                            {% endif %}
                <button class="action-button action-button--secondary js-toggle-notes" 
                    data-payout-id="{{ payout.id }}"
                    title="Edit Notes">
                                üìù
                            </button>
                        </div>
                    </td>
                </tr>
                <!-- Expandable Notes Row -->
                <tr class="notes-row" id="notes-row-{{ payout.id }}" style="display: none;">
                    <td colspan="11" style="padding: 0; background: rgba(15, 23, 42, 0.95);">
                        <div style="padding: 16px; border-top: 1px solid rgba(148, 163, 184, 0.1);">
                                <form method="post" action="/schedules/{{ run.id }}/payouts/{{ payout.id }}/note" 
                                    class="notes-edit-form" data-payout-id="{{ payout.id }}"
                                    style="display: flex; gap: 12px; align-items: flex-start;">
                                                                <input type="hidden" name="redirect_to" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                                <div style="flex: 0 0 180px;">
                                    <label style="display: block; margin-bottom: 6px; color: #cbd5e1; font-weight: 600; font-size: 13px;">Payment Status</label>
                                    <select name="status" 
                                            style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; font-size: 14px;">
                                        {% for option in status_options %}
                                            <option value="{{ option }}" {% if payout.status == option %}selected{% endif %}>
                                                {{ option.replace('_', ' ')|title }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 6px; color: #cbd5e1; font-weight: 600; font-size: 13px;">Notes</label>
                                    <textarea name="notes" 
                                              placeholder="Add context, tracking info, or payment details..." 
                                              style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; min-height: 80px; font-family: inherit; resize: vertical; font-size: 14px;">{{ payout.notes or '' }}</textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; padding-top: 28px;">
                                    <button class="button button--primary button--compact" type="submit">
                                        <span>üíæ</span>
                                        <span>Save</span>
                                    </button>
                                    <button class="button secondary button--compact js-toggle-notes" type="button" 
                                            data-payout-id="{{ payout.id }}">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td class="empty-state" colspan="11">No payouts match the current filters.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="table-summary-row">
        <div class="table-summary-label">Cycle Total</div>
        <div class="table-summary-value">{{ run.currency }} <span id="visible-total">{{ payout_total|money }}</span></div>
    </div>
    
    <!-- Sticky Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulk-actions-bar" style="display: none;">
        <div class="bulk-actions-bar__content">
            <div class="bulk-actions-bar__info">
                <span class="bulk-actions-bar__icon">‚òëÔ∏è</span>
                <span class="bulk-actions-bar__text">
                    <strong id="selected-count">0</strong> payment<span id="selected-plural">s</span> selected
                </span>
            </div>
            <form method="post" action="/schedules/{{ run.id }}/payouts/bulk-update" id="bulk-form" 
                  style="display: flex; gap: 12px; align-items: center;">
                <input type="hidden" id="bulk-payout-ids" name="payout_ids" value="">
                <input type="hidden" name="redirect_to" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label for="bulk-status" style="color: #e2e8f0; font-weight: 600; font-size: 14px;">Update Status:</label>
                    <select id="bulk-status" name="status" 
                            style="padding: 8px 12px; background: rgba(15, 23, 42, 0.9); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; font-size: 14px;">
                        {% for option in status_options %}
                            <option value="{{ option }}">{{ option.replace('_', ' ')|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="button button--primary button--compact" type="submit">
                    <span>‚úì</span>
                    <span>Apply</span>
                </button>
                <button class="button secondary button--compact" type="button" onclick="cancelBulkUpdate()">
                    <span>‚úï</span>
                    <span>Cancel</span>
                </button>
            </form>
        </div>
    </div>
</section>

<!-- Collapsible Validation Section -->
{% if validations|length > 0 %}
<section class="card validation-section" id="validation-section" style="margin-top: 32px; display: none;">
    <div class="section-heading">
        <div>
            <h2><span class="section-icon">‚ö†Ô∏è</span> Validation Issues</h2>
            <p style="color: #94a3b8; margin: 4px 0 0 0;">{{ validations|length }} issue{{ 's' if validations|length != 1 else '' }} detected</p>
        </div>
    </div>
    <div class="data-table-wrapper" style="margin-top: 16px;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 100px;">Severity</th>
                    <th style="width: 150px;">Model</th>
                    <th>Issue</th>
                </tr>
            </thead>
            <tbody>
                {% for item in validations %}
                <tr>
                    <td>
                        <span class="status-chip status-chip--{{ 'danger' if item.severity == 'error' else 'warning' }}">
                            {{ item.severity|title }}
                        </span>
                    </td>
                    <td>
                        <span style="font-weight: 600; color: #60a5fa;">{{ item.model.code if item.model else '‚Äî' }}</span>
                    </td>
                    <td style="color: #cbd5e1;">{{ item.issue }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<script>
// Toggle select all checkboxes
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.payout-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkSection();
}

// Update bulk actions bar visibility and count
function updateBulkSection() {
    const checkboxes = document.querySelectorAll('.payout-checkbox:checked');
    const bulkBar = document.getElementById('bulk-actions-bar');
    if (!bulkBar) {
        return;
    }
    const count = checkboxes.length;
    
    if (count > 0) {
        bulkBar.style.display = 'block';
        const selectedCount = document.getElementById('selected-count');
        const selectedPlural = document.getElementById('selected-plural');
        const bulkIdsInput = document.getElementById('bulk-payout-ids');

        if (selectedCount) {
            selectedCount.textContent = count;
        }
        if (selectedPlural) {
            selectedPlural.textContent = count === 1 ? '' : 's';
        }
        if (bulkIdsInput) {
            const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
            bulkIdsInput.value = ids;
        }
    } else {
        bulkBar.style.display = 'none';
    }
}

// Cancel bulk update
function cancelBulkUpdate() {
    document.querySelectorAll('.payout-checkbox').forEach(cb => cb.checked = false);
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
        selectAll.checked = false;
    }
    updateBulkSection();
}

// Quick status update via button
function quickUpdateStatus(payoutId, status) {
    // Try in-place update via JSON endpoint first; fallback to form submit on failure
    const endpoint = `/schedules/{{ run.id }}/payouts/${payoutId}/status`;
    const formData = new FormData();
    formData.append('status', status);

    fetch(endpoint, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'fetch' } })
        .then(async (res) => {
            if (!res.ok) throw new Error('Bad response');
            return res.json();
        })
        .then((data) => {
            if (!data || !data.ok) throw new Error('Update failed');
            const row = document.querySelector(`tr.payout-row[data-payout-id="${payoutId}"]`);
            if (!row) return;

            // Update data-status
            const newStatus = String(data.new_status || '').toLowerCase();
            row.setAttribute('data-status', newStatus);

            // Update overdue class/label
            const wasOverdue = row.classList.contains('payout-row--overdue');
            const isOverdue = !!data.is_overdue;
            if (isOverdue) {
                row.classList.add('payout-row--overdue');
            } else {
                row.classList.remove('payout-row--overdue');
            }
            // Toggle OVERDUE label inside status cell
            const statusCell = row.querySelector('[data-column-key="status"]');
            if (statusCell) {
                let label = statusCell.querySelector('.overdue-label');
                if (isOverdue && !label) {
                    label = document.createElement('span');
                    label.className = 'overdue-label';
                    label.textContent = 'OVERDUE';
                    statusCell.appendChild(label);
                } else if (!isOverdue && label) {
                    label.remove();
                }
            }

            // Update status chip text and variant
            const chip = row.querySelector('.status-chip');
            if (chip) {
                chip.textContent = newStatus.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
                chip.classList.remove('status-chip--success', 'status-chip--warning', 'status-chip--danger', 'status-chip--info', 'status-chip--neutral');
                if (newStatus === 'paid') chip.classList.add('status-chip--success');
                else if (newStatus === 'approved') chip.classList.add('status-chip--info');
                else if (newStatus === 'not_paid') chip.classList.add('status-chip--warning');
                else if (newStatus === 'on_hold') chip.classList.add('status-chip--danger');
                else chip.classList.add('status-chip--neutral');
            }

            // Update quick action buttons in-place
            const buttons = row.querySelectorAll('.js-quick-update');
            if (buttons && buttons.length >= 3) {
                const paidBtn = buttons[0]; // paid/unpaid
                const approvedBtn = buttons[1]; // approved/not_paid
                const holdBtn = buttons[2];    // hold/not_paid

                // Paid toggle button
                if (newStatus === 'paid') {
                    paidBtn.classList.remove('action-button--success');
                    paidBtn.classList.add('action-button--neutral');
                    paidBtn.setAttribute('data-action', 'not_paid');
                    paidBtn.setAttribute('title', 'Unmark Paid');
                    paidBtn.textContent = '‚Ü∫';
                } else {
                    paidBtn.classList.remove('action-button--neutral');
                    paidBtn.classList.add('action-button--success');
                    paidBtn.setAttribute('data-action', 'paid');
                    paidBtn.setAttribute('title', 'Mark as Paid');
                    paidBtn.textContent = '‚úì';
                }
                // Approved toggle button
                if (newStatus === 'approved') {
                    approvedBtn.classList.remove('action-button--primary');
                    approvedBtn.classList.add('action-button--neutral');
                    approvedBtn.setAttribute('data-action', 'not_paid');
                    approvedBtn.setAttribute('title', 'Unmark Approved');
                    approvedBtn.textContent = '‚Ü∫';
                } else {
                    approvedBtn.classList.remove('action-button--neutral');
                    approvedBtn.classList.add('action-button--primary');
                    approvedBtn.setAttribute('data-action', 'approved');
                    approvedBtn.setAttribute('title', 'Mark Approved');
                    approvedBtn.textContent = '‚úî';
                }

                // Hold button
                if (newStatus === 'on_hold') {
                    holdBtn.classList.remove('action-button--warning');
                    holdBtn.classList.add('action-button--neutral');
                    holdBtn.setAttribute('data-action', 'not_paid');
                    holdBtn.setAttribute('title', 'Remove Hold');
                    holdBtn.textContent = '‚ñ∂';
                } else {
                    holdBtn.classList.remove('action-button--neutral');
                    holdBtn.classList.add('action-button--warning');
                    holdBtn.setAttribute('data-action', 'on_hold');
                    holdBtn.setAttribute('title', 'Put On Hold');
                    holdBtn.textContent = '‚è∏';
                }
            }

            // Recompute totals if that widget exists
            if (typeof recomputeVisibleTotal === 'function') {
                try { recomputeVisibleTotal(); } catch (_) { }
            }
        })
        .catch(() => {
            // Fallback to original form submit behavior to preserve functionality
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/schedules/{{ run.id }}/payouts/${payoutId}/note`;
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = status;
            const notesInput = document.createElement('input');
            notesInput.type = 'hidden';
            notesInput.name = 'notes';
            notesInput.value = '';
            const redirectInput = document.createElement('input');
            redirectInput.type = 'hidden';
            redirectInput.name = 'redirect_to';
            redirectInput.value = window.location.pathname + window.location.search;
            form.appendChild(statusInput);
            form.appendChild(notesInput);
            form.appendChild(redirectInput);
            document.body.appendChild(form);
            form.submit();
        });
}

// Toggle notes row for editing
function toggleNotesRow(payoutId) {
    const notesRow = document.getElementById(`notes-row-${payoutId}`);
    if (!notesRow) {
        return;
    }
    if (notesRow.style.display === 'none') {
        // Hide all other notes rows
        document.querySelectorAll('.notes-row').forEach(row => {
            row.style.display = 'none';
        });
        notesRow.style.display = '';
    } else {
        notesRow.style.display = 'none';
    }
}

// Toggle validation section
function toggleValidation() {
    const section = document.getElementById('validation-section');
    const toggleText = document.getElementById('validation-toggle-text');
    if (!section || !toggleText) {
        return;
    }
    if (section.style.display === 'none') {
        section.style.display = 'block';
        toggleText.textContent = 'Hide Details';
    } else {
        section.style.display = 'none';
        toggleText.textContent = 'Show Details';
    }
}

function syncStatusDropdown(status) {
    const statusSelect = document.getElementById('filter-status');
    if (!statusSelect) return false;

    const hasOption = Array.from(statusSelect.options).some(option => option.value === (status || ''));
    if (!hasOption) {
        return false;
    }

    statusSelect.value = status || '';
    updateExportExcelHref(status);
    return true;
}

// Filter by status (chip buttons). Keep dropdown selection mirrored, then filter locally.
function filterByStatus(status) {
    syncStatusDropdown(status);
    applyStatusFilterLocally(status);
}

function applyStatusFilterLocally(status) {
    const tableBody = document.querySelector('#payouts-table tbody');
    if (!tableBody) return;

    const rows = Array.from(tableBody.querySelectorAll('tr.payout-row'));
    let visibleCount = 0;

    rows.forEach(row => {
        const rowStatus = (row.getAttribute('data-status') || '').toLowerCase();
        const match = !status || rowStatus === status.toLowerCase();
        if (match) {
            row.style.display = '';
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow && notesRow.style.display !== 'none') {
                notesRow.style.display = '';
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow) notesRow.style.display = 'none';
        }
    });

    const visibleCountEl = document.getElementById('visible-count');
    if (visibleCountEl) visibleCountEl.textContent = visibleCount;

    const url = new URL(window.location.href);
    if (status) url.searchParams.set('status', status);
    else url.searchParams.delete('status');
    history.replaceState(null, '', url.toString());

    if (typeof recomputeVisibleTotal === 'function') {
        try { recomputeVisibleTotal(); } catch (_) { }
    }
}

// Filter by overdue (client-side)
function filterByOverdue() {
    syncStatusDropdown('overdue');
    updateExportExcelHref('overdue');

    const searchInput = document.getElementById('quick-search');
    if (searchInput) {
        searchInput.value = '';
    }
    
    const tableBody = document.querySelector('#payouts-table tbody');
    if (!tableBody) {
        return;
    }
    const rows = Array.from(tableBody.querySelectorAll('tr.payout-row'));
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const isOverdue = row.getAttribute('data-is-overdue') === 'true';
        
        if (isOverdue) {
            row.style.display = '';
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow && notesRow.style.display !== 'none') {
                notesRow.style.display = '';
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow) {
                notesRow.style.display = 'none';
            }
        }
    });
    
    const visibleCountEl = document.getElementById('visible-count');
    if (visibleCountEl) {
        visibleCountEl.textContent = visibleCount;
    }
    // Clear quick search and persist removal
    const hiddenQ = document.getElementById('filter-q-hidden');
    if (searchInput) searchInput.value = '';
    if (hiddenQ) hiddenQ.value = '';
    const url = new URL(window.location.href);
    url.searchParams.delete('q');
    history.replaceState(null, '', url.toString());
    recomputeVisibleTotal();
}

function updateExportExcelHref(status) {
    const excelLink = document.getElementById('export-excel');
    if (!excelLink) return;

    const base = excelLink.getAttribute('data-base-href') || excelLink.href.split('?')[0];
    const url = new URL(base, window.location.origin);

    // If caller provided an explicit status, prefer it; otherwise fall back to dropdown value
    let newStatus = status;
    if (!newStatus) {
        const statusSelect = document.getElementById('filter-status');
        newStatus = statusSelect ? statusSelect.value : '';
    }

    url.searchParams.delete('status');
    if (newStatus) {
        url.searchParams.set('status', newStatus);
    }

    // Keep existing path and query params - update only to new status
    excelLink.href = url.pathname + url.search;
}

// Ensure export link is correct on load and whenever select changes
document.addEventListener('DOMContentLoaded', () => {
    updateExportExcelHref();
    const statusSelect = document.getElementById('filter-status');
    if (statusSelect) statusSelect.addEventListener('change', () => updateExportExcelHref());
});

// Client-side quick search filter
function filterPayoutTable() {
    const searchInput = document.getElementById('quick-search');
    const tableBody = document.querySelector('#payouts-table tbody');
    if (!searchInput || !tableBody) {
        return;
    }
    const searchTerm = searchInput.value.toLowerCase();
    const rows = Array.from(tableBody.querySelectorAll('tr.payout-row'));
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const code = row.getAttribute('data-code') || '';
        const name = row.getAttribute('data-name') || '';
        
        const matchesSearch = !searchTerm || 
            code.includes(searchTerm) || 
            name.includes(searchTerm);
        
        if (matchesSearch) {
            row.style.display = '';
            // Also show the associated notes row if it was visible
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow && notesRow.style.display !== 'none') {
                notesRow.style.display = '';
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Hide associated notes row
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow) {
                notesRow.style.display = 'none';
            }
        }
    });
    
    // Update count
    const visibleCountEl = document.getElementById('visible-count');
    if (visibleCountEl) {
        visibleCountEl.textContent = visibleCount;
    }
    // Persist quick search to URL and hidden form field
    const hiddenQ = document.getElementById('filter-q-hidden');
    if (hiddenQ) hiddenQ.value = searchTerm;
    const url = new URL(window.location.href);
    if (searchTerm) {
        url.searchParams.set('q', searchTerm);
    } else {
        url.searchParams.delete('q');
    }
    history.replaceState(null, '', url.toString());
    recomputeVisibleTotal();
}

// Column order + sorting state
const DEFAULT_COLUMN_ORDER = [
    'select',
    'pay_date',
    'code',
    'working_name',
    'payment_method',
    'frequency',
    'amount',
    'deductions',
    'status',
    'notes',
    'actions',
];
const COLUMN_STORAGE_KEY = `schedule_columns_run_{{ run.id }}`;
let columnOrderState = [...DEFAULT_COLUMN_ORDER];
let draggingColumnKey = null;
let sortDirection = {};

function sortTable(columnKey) {
    const table = document.querySelector('#payouts-table');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr.payout-row'));
    if (!rows.length) return;

    const isAscending = sortDirection[columnKey] !== true;
    sortDirection = { [columnKey]: isAscending };

    const parseDate = (value) => {
        const parts = value.split('/');
        if (parts.length === 3) {
            return new Date(`${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`);
        }
        return new Date(value);
    };

    rows.sort((rowA, rowB) => {
        const cellA = rowA.querySelector(`[data-column-key="${columnKey}"]`);
        const cellB = rowB.querySelector(`[data-column-key="${columnKey}"]`);
        const valueA = (cellA ? cellA.textContent : '').trim();
        const valueB = (cellB ? cellB.textContent : '').trim();

        if (columnKey === 'pay_date') {
            const dateA = parseDate(valueA);
            const dateB = parseDate(valueB);
            return isAscending ? dateA - dateB : dateB - dateA;
        }

        if (columnKey === 'amount' || columnKey === 'deductions') {
            const numA = parseFloat(valueA.replace(/[^\d.-]/g, ''));
            const numB = parseFloat(valueB.replace(/[^\d.-]/g, ''));
            if (!isNaN(numA) && !isNaN(numB)) {
                return isAscending ? numA - numB : numB - numA;
            }
        }

        const textA = valueA.toLowerCase();
        const textB = valueB.toLowerCase();
        return isAscending ? textA.localeCompare(textB) : textB.localeCompare(textA);
    });

    rows.forEach(row => {
        tbody.appendChild(row);
        const payoutId = row.getAttribute('data-payout-id');
        const notesRow = document.getElementById(`notes-row-${payoutId}`);
        if (notesRow) {
            tbody.appendChild(notesRow);
        }
    });

    document.querySelectorAll('#payouts-table thead th[data-sortable="true"]').forEach(th => {
        if (th.dataset.columnKey === columnKey) {
            th.dataset.sortDirection = isAscending ? 'asc' : 'desc';
        } else {
            th.dataset.sortDirection = '';
        }
    });
}

function initializeColumnOrder() {
    columnOrderState = loadColumnOrder();
    applyColumnOrder(columnOrderState);

    const headerCells = document.querySelectorAll('#payouts-table thead th[data-draggable="true"]');
    headerCells.forEach(cell => {
        cell.addEventListener('dragstart', handleColumnDragStart);
        cell.addEventListener('dragover', handleColumnDragOver);
        cell.addEventListener('dragleave', handleColumnDragLeave);
        cell.addEventListener('drop', handleColumnDrop);
        cell.addEventListener('dragend', handleColumnDragEnd);
    });
}

function loadColumnOrder() {
    try {
        const stored = localStorage.getItem(COLUMN_STORAGE_KEY);
        if (stored) {
            const parsed = JSON.parse(stored);
            if (Array.isArray(parsed) && parsed.length) {
                return normalizeColumnOrder(parsed);
            }
        }
    } catch (err) {
        console.warn('Unable to load column order', err);
    }
    return [...DEFAULT_COLUMN_ORDER];
}

function saveColumnOrder(order) {
    try {
        localStorage.setItem(COLUMN_STORAGE_KEY, JSON.stringify(order));
    } catch (err) {
        console.warn('Unable to persist column order', err);
    }
}

function normalizeColumnOrder(order) {
    const cleaned = order.filter(key => DEFAULT_COLUMN_ORDER.includes(key));
    DEFAULT_COLUMN_ORDER.forEach(key => {
        if (!cleaned.includes(key)) {
            cleaned.push(key);
        }
    });
    return cleaned;
}

function applyColumnOrder(order) {
    const normalized = normalizeColumnOrder(order);
    columnOrderState = normalized;
    const table = document.getElementById('payouts-table');
    if (!table) return;

    const headerRow = table.querySelector('thead tr');
    if (headerRow) reorderRowCells(headerRow, normalized);

    table.querySelectorAll('tbody tr.payout-row').forEach(row => reorderRowCells(row, normalized));
    const footerRows = table.querySelectorAll('tfoot tr');
    footerRows.forEach(row => reorderRowCells(row, normalized));
}

function reorderRowCells(row, order) {
    const cells = Array.from(row.children);
    if (!cells.length) return;
    const fragment = document.createDocumentFragment();
    order.forEach(key => {
        const cell = cells.find(c => c.dataset && c.dataset.columnKey === key);
        if (cell) {
            fragment.appendChild(cell);
        }
    });
    row.appendChild(fragment);
}

function handleColumnDragStart(event) {
    const target = event.currentTarget;
    draggingColumnKey = target.dataset.columnKey;
    if (!draggingColumnKey) return;
    target.dataset.dragging = 'true';
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', draggingColumnKey);
}

function handleColumnDragOver(event) {
    if (!draggingColumnKey) return;
    const target = event.currentTarget;
    const targetKey = target.dataset.columnKey;
    if (!targetKey || targetKey === draggingColumnKey) return;
    event.preventDefault();
    document.querySelectorAll('#payouts-table thead th[data-drop-target="true"]').forEach(th => th.removeAttribute('data-drop-target'));
    target.dataset.dropTarget = 'true';
}

function handleColumnDragLeave(event) {
    event.currentTarget.removeAttribute('data-drop-target');
}

function handleColumnDrop(event) {
    if (!draggingColumnKey) return;
    event.preventDefault();
    const targetKey = event.currentTarget.dataset.columnKey;
    if (!targetKey || targetKey === draggingColumnKey) return;

    const newOrder = moveColumnKey(columnOrderState, draggingColumnKey, targetKey);
    columnOrderState = newOrder;
    saveColumnOrder(columnOrderState);
    applyColumnOrder(columnOrderState);
}

function handleColumnDragEnd() {
    draggingColumnKey = null;
    document.querySelectorAll('#payouts-table thead th').forEach(th => {
        th.removeAttribute('data-drop-target');
        th.removeAttribute('data-dragging');
    });
}

function moveColumnKey(order, fromKey, toKey) {
    const normalized = normalizeColumnOrder(order);
    const fromIndex = normalized.indexOf(fromKey);
    const toIndex = normalized.indexOf(toKey);
    if (fromIndex === -1 || toIndex === -1) {
        return normalized;
    }
    normalized.splice(toIndex, 0, normalized.splice(fromIndex, 1)[0]);
    return normalized;
}

// Auto-filter on page load if URL parameter is present
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const showFilter = urlParams.get('show');
    const persistedQ = urlParams.get('q') || '';
    
    if (showFilter === 'overdue') {
        // Trigger the overdue filter
        filterByOverdue();
        
        // Scroll to the table
        const table = document.getElementById('payouts-table');
        if (table) {
            setTimeout(() => {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }
    // Reapply persisted quick search
    if (persistedQ) {
        const searchInput = document.getElementById('quick-search');
        const hiddenQ = document.getElementById('filter-q-hidden');
        if (searchInput) searchInput.value = persistedQ;
        if (hiddenQ) hiddenQ.value = persistedQ;
        filterPayoutTable();
    }
    // Compute initial visible total on load as well
    recomputeVisibleTotal();
    // Ensure notes forms redirect back including current quick search and filters
    document.querySelectorAll('form[action$="/note"]').forEach(form => {
        form.addEventListener('submit', function() {
            const redirectInput = form.querySelector('input[name="redirect_to"]');
            if (redirectInput) {
                redirectInput.value = window.location.pathname + window.location.search;
            }
        });
    });

    initializeColumnOrder();
});

// Money formatting helper (US style, 2 decimals)
function formatMoney(value) {
    try {
        return (Number(value) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } catch (e) {
        const n = Math.round((Number(value) || 0) * 100) / 100;
        return n.toFixed(2);
    }
}

// Recompute visible total based on currently visible rows
function recomputeVisibleTotal() {
    const rows = Array.from(document.querySelectorAll('#payouts-table tbody tr.payout-row'));
    if (!rows.length) {
        const el = document.getElementById('visible-total');
        if (el) el.textContent = formatMoney(0);
        return;
    }
    let total = 0;
    rows.forEach(row => {
        if (row.style.display === 'none') return;
        const amount = parseFloat(row.getAttribute('data-amount') || '0');
        if (!isNaN(amount)) total += amount;
    });
    const totalEl = document.getElementById('visible-total');
    if (totalEl) {
        totalEl.textContent = formatMoney(total);
    }
}

// Delegated click handlers for quick updates and toggling notes
document.addEventListener('click', function (e) {
    const quickBtn = e.target.closest('.js-quick-update');
    if (quickBtn) {
        const payoutId = quickBtn.getAttribute('data-payout-id');
        const action = quickBtn.getAttribute('data-action');
        if (payoutId && action) {
            quickUpdateStatus(payoutId, action);
        }
        return;
    }
    const notesBtn = e.target.closest('.js-toggle-notes');
    if (notesBtn) {
        const payoutId = notesBtn.getAttribute('data-payout-id');
        if (payoutId) {
            toggleNotesRow(payoutId);
        }
    }
});

// Intercept bulk form submit for in-place updates
document.addEventListener('submit', function (e) {
    const notesForm = e.target.closest('.notes-edit-form');
    if (notesForm) {
        if (notesForm.dataset.ajaxFallback === '1') {
            return;
        }
        e.preventDefault();
        submitNotesFormAjax(notesForm);
        return;
    }

    const form = e.target.closest('#bulk-form');
    if (!form) return;
    e.preventDefault();
    const ids = document.getElementById('bulk-payout-ids')?.value || '';
    const statusSel = document.getElementById('bulk-status');
    const status = statusSel ? statusSel.value : '';
    if (!ids || !status) return;

    const endpoint = `/schedules/{{ run.id }}/payouts/bulk-update/status`;
    const fd = new FormData();
    fd.append('payout_ids', ids);
    fd.append('status', status);

    fetch(endpoint, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'fetch' } })
        .then(async (res) => {
            if (!res.ok) throw new Error('Bad response');
            return res.json();
        })
        .then((data) => {
            if (!data || !data.ok) throw new Error('Update failed');
            const updatedIds = data.updated_ids || [];
            const overdue_flags = data.overdue_flags || {};
            const newStatus = String(data.new_status || '').toLowerCase();

            updatedIds.forEach((pid) => {
                applyRowStatusUpdate(String(pid), newStatus, !!overdue_flags[pid]);
            });

            // Clear selection and hide bulk bar
            cancelBulkUpdate();
            if (typeof recomputeVisibleTotal === 'function') {
                try { recomputeVisibleTotal(); } catch (_) { }
            }
        })
        .catch(() => {
            // Fallback to regular submit if fetch fails
            form.submit();
        });
});

function submitNotesFormAjax(form) {
    const payoutId = form.getAttribute('data-payout-id');
    if (!payoutId) {
        form.dataset.ajaxFallback = '1';
        form.submit();
        return;
    }

    const formData = new FormData(form);
    formData.set('redirect_to', window.location.pathname + window.location.search);

    fetch(form.action, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'fetch' } })
        .then(async (res) => {
            if (!res.ok) throw new Error('Bad response');
            return res.json();
        })
        .then((data) => {
            if (!data || !data.ok) throw new Error('Update failed');
            updateNoteDisplay(payoutId, data.note || '');
            if (typeof applyRowStatusUpdate === 'function' && data.status) {
                try {
                    applyRowStatusUpdate(String(payoutId), String(data.status).toLowerCase(), !!data.is_overdue);
                } catch (_) {
                    // no-op if helper unavailable
                }
            }
            toggleNotesRow(payoutId);
        })
        .catch(() => {
            form.dataset.ajaxFallback = '1';
            form.submit();
        });
}

function updateNoteDisplay(payoutId, noteText) {
    const row = document.querySelector(`tr.payout-row[data-payout-id="${payoutId}"]`);
    if (!row) return;
    const noteEl = row.querySelector('.payout-note-text');
    if (!noteEl) return;

    const trimmed = (noteText || '').trim();
    if (trimmed) {
        noteEl.textContent = trimmed;
        noteEl.title = trimmed;
        noteEl.classList.remove('payout-note-text--empty');
    } else {
        noteEl.textContent = '‚Äî';
        noteEl.title = 'No notes yet';
        noteEl.classList.add('payout-note-text--empty');
    }
}

// Helper to apply DOM updates after a status change
function applyRowStatusUpdate(payoutId, newStatus, isOverdue) {
    const row = document.querySelector(`tr.payout-row[data-payout-id="${payoutId}"]`);
    if (!row) return;
    row.setAttribute('data-status', newStatus);

    if (isOverdue) row.classList.add('payout-row--overdue');
    else row.classList.remove('payout-row--overdue');

    const statusCell = row.querySelector('[data-column-key="status"]');
    if (statusCell) {
        let label = statusCell.querySelector('.overdue-label');
        if (isOverdue && !label) {
            label = document.createElement('span');
            label.className = 'overdue-label';
            label.textContent = 'OVERDUE';
            statusCell.appendChild(label);
        } else if (!isOverdue && label) {
            label.remove();
        }
    }

    const chip = row.querySelector('.status-chip');
    if (chip) {
        chip.textContent = newStatus.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
    chip.classList.remove('status-chip--success', 'status-chip--warning', 'status-chip--danger', 'status-chip--info', 'status-chip--neutral');
    if (newStatus === 'paid') chip.classList.add('status-chip--success');
    else if (newStatus === 'approved') chip.classList.add('status-chip--info');
    else if (newStatus === 'not_paid') chip.classList.add('status-chip--warning');
    else if (newStatus === 'on_hold') chip.classList.add('status-chip--danger');
    else chip.classList.add('status-chip--neutral');
    }

    const buttons = row.querySelectorAll('.js-quick-update');
    if (buttons && buttons.length >= 2) {
        const primaryBtn = buttons[0];
        const holdBtn = buttons[1];
        if (newStatus === 'paid') {
            primaryBtn.classList.remove('action-button--success');
            primaryBtn.classList.add('action-button--neutral');
            primaryBtn.setAttribute('data-action', 'not_paid');
            primaryBtn.setAttribute('title', 'Unmark Paid');
            primaryBtn.textContent = '‚Ü∫';
        } else {
            primaryBtn.classList.remove('action-button--neutral');
            primaryBtn.classList.add('action-button--success');
            primaryBtn.setAttribute('data-action', 'paid');
            primaryBtn.setAttribute('title', 'Mark as Paid');
            primaryBtn.textContent = '‚úì';
        }
        if (newStatus === 'on_hold') {
            holdBtn.classList.remove('action-button--warning');
            holdBtn.classList.add('action-button--neutral');
            holdBtn.setAttribute('data-action', 'not_paid');
            holdBtn.setAttribute('title', 'Remove Hold');
            holdBtn.textContent = '‚ñ∂';
        } else {
            holdBtn.classList.remove('action-button--neutral');
            holdBtn.classList.add('action-button--warning');
            holdBtn.setAttribute('data-action', 'on_hold');
            holdBtn.setAttribute('title', 'Put On Hold');
            holdBtn.textContent = '‚è∏';
        }
    }
}
</script>

<style>
/* Schedule payouts table header and column sizing */
.data-table.schedule-payouts-table {
    table-layout: auto;
}

.data-table.schedule-payouts-table thead th {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: bottom;
    position: relative;
    user-select: none;
}

.column-label {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

th[data-sortable="true"] {
    cursor: pointer;
}

th[data-sortable="true"] .column-label::after {
    content: '';
    margin-left: 4px;
    font-size: 12px;
    color: #94a3b8;
}

th[data-sort-direction="asc"] .column-label::after {
    content: '‚ñ≤';
}

th[data-sort-direction="desc"] .column-label::after {
    content: '‚ñº';
}

th[data-draggable="true"] {
    cursor: grab;
}

th[data-dragging="true"] {
    opacity: 0.6;
}

th[data-drop-target="true"]::after {
    content: '';
    position: absolute;
    top: 0;
    right: -4px;
    width: 4px;
    height: 100%;
    background: rgba(59, 130, 246, 0.6);
}

.column-select { width: 60px; }
.column-pay_date { width: 140px; }
.column-code { width: 120px; }
.column-payment_method { width: 150px; }
.column-frequency { width: 140px; }
.column-amount { width: 150px; }
.column-deductions { width: 140px; text-align: center; }
.column-status { width: 140px; text-align: center; }
.column-notes { width: 260px; }
.column-actions { width: 160px; }

.table-summary-row {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    margin-top: 12px;
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 10px;
    background: rgba(15, 23, 42, 0.85);
}

.table-summary-label {
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 13px;
    color: #94a3b8;
}

.table-summary-value {
    font-size: 18px;
    font-weight: 600;
    color: #3b82f6;
}

/* Schedule Metrics Dashboard */
.schedule-metrics-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.schedule-metric {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s ease;
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35);
}

.schedule-metric:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.5);
}

.schedule-metric--primary {
    border-left: 4px solid #3b82f6;
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--success {
    border-left: 4px solid #22c55e;
    background: linear-gradient(145deg, rgba(34, 197, 94, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--warning {
    border-left: 4px solid #eab308;
    background: linear-gradient(145deg, rgba(234, 179, 8, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--neutral {
    border-left: 4px solid #94a3b8;
}

.schedule-metric--danger {
    border-left: 4px solid #ef4444;
    background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--alert {
    animation: pulse-alert 2s ease-in-out infinite;
}

@keyframes pulse-alert {
    0%, 100% {
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3);
    }
    50% {
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.6);
    }
}

.schedule-metric__header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.schedule-metric__icon {
    font-size: 20px;
}

.schedule-metric__label {
    font-size: 13px;
    font-weight: 500;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.schedule-metric__value {
    font-size: 32px;
    font-weight: 700;
    color: #f8fafc;
    margin-bottom: 8px;
}

.schedule-metric__value--compact {
    font-size: 28px;
}

.schedule-metric__breakdown {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #94a3b8;
    flex-wrap: wrap;
}

.schedule-metric__item {
    color: #cbd5e1;
}

.schedule-metric__divider {
    color: #475569;
}

/* Alert Banner */
.alert-banner {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.3);
}

.alert-banner--warning {
    border-left: 4px solid #eab308;
    background: linear-gradient(145deg, rgba(234, 179, 8, 0.15), rgba(15, 23, 42, 0.9));
}

.alert-banner__icon {
    font-size: 24px;
}

.alert-banner__content {
    flex: 1;
}

.alert-banner__title {
    font-weight: 600;
    color: #f8fafc;
    margin-bottom: 4px;
}

.alert-banner__message {
    font-size: 14px;
    color: #94a3b8;
}

.alert-banner__action {
    padding: 8px 16px;
    background: rgba(59, 130, 246, 0.15);
    color: #60a5fa;
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.alert-banner__action:hover {
    background: rgba(59, 130, 246, 0.25);
}

/* Filter Toolbar */
.schedule-filter-toolbar {
    display: flex;
    gap: 16px;
    margin-top: 20px;
    padding: 20px;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 12px;
    align-items: flex-end;
}

.schedule-filter-toolbar__search {
    flex: 1;
    min-width: 250px;
}

.filter-search-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 8px;
    font-size: 14px;
    background: rgba(15, 23, 42, 0.8);
    color: #f8fafc;
    transition: all 0.2s ease;
}

.filter-search-input:focus {
    outline: none;
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.schedule-filter-toolbar__filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
    flex: 2;
}

.filter-group-inline {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 140px;
}

.filter-group-inline label {
    font-size: 12px;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-select {
    padding: 10px 12px;
    background: rgba(15, 23, 42, 0.8);
    color: #f8fafc;
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-select:hover {
    border-color: rgba(148, 163, 184, 0.3);
    background: rgba(15, 23, 42, 0.9);
}

.filter-select:focus {
    outline: none;
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.filter-clear-button {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    white-space: nowrap;
}

.filter-clear-button:hover {
    background: rgba(239, 68, 68, 0.25);
    border-color: rgba(239, 68, 68, 0.4);
    transform: translateY(-1px);
}

/* Status Filter Chips */
.status-chip-filter {
    padding: 8px 16px;
    background: rgba(15, 23, 42, 0.6);
    color: #cbd5e1;
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.status-chip-filter:hover {
    background: rgba(15, 23, 42, 0.8);
    border-color: rgba(148, 163, 184, 0.3);
}

.status-chip-filter--active {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    border-color: rgba(59, 130, 246, 0.4);
}

.status-chip-filter--paid {
    border-color: rgba(34, 197, 94, 0.3);
}

.status-chip-filter--paid.status-chip-filter--active {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.4);
}

.status-chip-filter--not_paid {
    border-color: rgba(234, 179, 8, 0.3);
}

.status-chip-filter--not_paid.status-chip-filter--active {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
    border-color: rgba(234, 179, 8, 0.4);
}

.status-chip-filter--on_hold {
    border-color: rgba(239, 68, 68, 0.3);
}

.status-chip-filter--on_hold.status-chip-filter--active {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.4);
}

.status-chip-filter--overdue {
    border-color: rgba(239, 68, 68, 0.4);
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    font-weight: 700;
    animation: pulse-border 2s ease-in-out infinite;
}

.status-chip-filter--overdue:hover {
    background: rgba(239, 68, 68, 0.3);
}

@keyframes pulse-border {
    0%, 100% {
        border-color: rgba(239, 68, 68, 0.4);
    }
    50% {
        border-color: rgba(239, 68, 68, 0.7);
    }
}

/* Payout Table Rows */
.payout-row {
    transition: background-color 0.15s ease;
}

.payout-row:hover {
    background-color: rgba(30, 41, 59, 0.5) !important;
}

.payout-row--paid {
    background: rgba(34, 197, 94, 0.05);
}

.payout-row--not_paid {
    background: rgba(234, 179, 8, 0.05);
}

.payout-row--on_hold {
    background: rgba(239, 68, 68, 0.05);
}
.payout-row--approved {
    background: rgba(59, 130, 246, 0.07);
}

.payout-row--overdue {
    background: rgba(239, 68, 68, 0.15) !important;
    border-left: 3px solid #ef4444;
}

.payout-row--overdue:hover {
    background-color: rgba(239, 68, 68, 0.25) !important;
}

.overdue-badge {
    display: inline-block;
    margin-left: 8px;
    font-size: 16px;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

.overdue-label {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 8px;
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.notes-row {
    background: rgba(15, 23, 42, 0.95) !important;
}

.payout-note-cell {
    color: #cbd5e1;
    max-width: 240px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.payout-note-text--empty {
    color: #475569;
    font-style: italic;
}

/* Action Buttons */
.action-button {
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    background: rgba(15, 23, 42, 0.6);
    color: #cbd5e1;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 14px;
}

.action-button:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.action-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.action-button--success {
    border-color: rgba(34, 197, 94, 0.3);
    color: #22c55e;
}

.action-button--success:hover:not(:disabled) {
    background: rgba(34, 197, 94, 0.15);
    border-color: rgba(34, 197, 94, 0.5);
}

.action-button--warning {
    border-color: rgba(234, 179, 8, 0.3);
    color: #eab308;
}

.action-button--warning:hover:not(:disabled) {
    background: rgba(234, 179, 8, 0.15);
    border-color: rgba(234, 179, 8, 0.5);
}

.action-button--secondary {
    border-color: rgba(148, 163, 184, 0.2);
    color: #94a3b8;
}

.action-button--secondary:hover:not(:disabled) {
    background: rgba(148, 163, 184, 0.1);
    border-color: rgba(148, 163, 184, 0.3);
}

.action-button--neutral {
    border-color: rgba(148, 163, 184, 0.3);
    color: #cbd5e1;
}

.action-button--neutral:hover:not(:disabled) {
    background: rgba(148, 163, 184, 0.15);
    border-color: rgba(148, 163, 184, 0.4);
}

.action-button--primary {
    border-color: rgba(59, 130, 246, 0.4);
    color: #3b82f6;
}
.action-button--primary:hover:not(:disabled) {
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.6);
}

/* Info status chip */
.status-chip--info {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.4);
}

/* Approved filter chip */
.status-chip-filter--approved { border-color: rgba(59,130,246,0.3); }
.status-chip-filter--approved.status-chip-filter--active {
    background: rgba(59,130,246,0.2);
    color: #3b82f6;
    border-color: rgba(59,130,246,0.4);
}

/* Bulk Actions Bar */
.bulk-actions-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.98));
    border-top: 1px solid rgba(59, 130, 246, 0.3);
    box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5);
    padding: 16px 24px;
    z-index: 100;
    backdrop-filter: blur(10px);
}

.bulk-actions-bar__content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
}

.bulk-actions-bar__info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.bulk-actions-bar__icon {
    font-size: 24px;
}

.bulk-actions-bar__text {
    font-size: 15px;
    color: #e2e8f0;
}

.bulk-actions-bar__text strong {
    color: #60a5fa;
    font-size: 18px;
}

/* Responsive Styles */
@media (max-width: 1024px) {
    .schedule-filter-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .schedule-filter-toolbar__search {
        min-width: 0;
    }
    
    .schedule-filter-toolbar__filters {
        flex-direction: column;
        align-items: stretch;
        flex: 1;
    }
    
    .filter-group-inline {
        min-width: 0;
        width: 100%;
    }
}

@media (max-width: 640px) {
    /* Hero metrics on mobile */
    .schedule-metrics-dashboard {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    /* Page header on mobile */
    .page-header .header-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }
    
    .page-header .header-actions .button {
        width: 100%;
        justify-content: center;
    }
    
    /* Section heading adjustments */
    .section-heading {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    /* Filter toolbar on mobile */
    .schedule-filter-toolbar {
        padding: 12px;
    }
    
    /* Status filter chips wrap properly */
    .status-filter-chips {
        gap: 6px !important;
    }
    
    .status-chip-filter {
        font-size: 12px;
        padding: 6px 10px;
    }
    
    /* Make table scrollable on mobile */
    .data-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-left: -16px;
        margin-right: -16px;
        padding-left: 16px;
        padding-right: 16px;
    }
    
    .data-table {
        min-width: 900px;
        font-size: 13px;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 6px;
    }
    
    /* Compact action buttons */
    .action-button {
        padding: 4px 8px;
        font-size: 11px;
    }
    
    /* Filter clear button */
    .filter-clear-button {
        width: 100%;
        justify-content: center;
    }
}
</style>

{% endblock %}
