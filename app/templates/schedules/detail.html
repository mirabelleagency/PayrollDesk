{% extends "base.html" %}
{% block title %}Payroll Cycle {{ run.id }} ¬∑ Payroll Desk{% endblock %}
{% block content %}

<!-- Page Header -->
<section class="page-header" style="margin-bottom: 24px;">
    <div>
    <h1 class="page-title">üí≥ {{ run.cycle_display }} Payroll Cycle</h1>
        <p style="color: #94a3b8; margin: 8px 0 0 0;">
            <span>Cycle #{{ run.id }}</span>
            <span style="margin: 0 8px; color: #475569;">‚Ä¢</span>
            <span>Generated {{ run.created_at|display_date }}</span>
            <span style="margin: 0 8px; color: #475569;">‚Ä¢</span>
            <span>Currency: {{ run.currency }}</span>
        </p>
    </div>
    <div class="header-actions">
        <a class="button secondary" href="/schedules">
            <span>‚Üê Back to Cycles</span>
        </a>
        <a class="button button--primary" href="/schedules/{{ run.id }}/download/schedule_csv">
            <span>üì•</span>
            <span>Export Schedule</span>
        </a>
    </div>
</section>

<!-- Validation Alerts (if any) -->
{% if validations|length > 0 %}
<section class="alert-banner alert-banner--warning" style="margin-bottom: 24px;">
    <div class="alert-banner__icon">‚ö†Ô∏è</div>
    <div class="alert-banner__content">
        <div class="alert-banner__title">{{ validations|length }} Validation Issue{{ 's' if validations|length != 1 else '' }}</div>
        <div class="alert-banner__message">Review issues before processing payments</div>
    </div>
    <button class="alert-banner__action" onclick="toggleValidation()">
        <span id="validation-toggle-text">Show Details</span>
    </button>
</section>
{% endif %}

<!-- Hero Metrics Dashboard -->
<section class="schedule-metrics-dashboard">
    <div class="schedule-metric schedule-metric--primary">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">‚úÖ</span>
            <span class="schedule-metric__label">Paid This Cycle</span>
        </div>
        <div class="schedule-metric__value">{{ run.currency }} {{ summary.paid_total|money }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">{{ summary.paid_models }} models</span>
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item">{{ status_counts.get('paid', 0) }} payments</span>
        </div>
    </div>

    <div class="schedule-metric schedule-metric--warning">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">‚è≥</span>
            <span class="schedule-metric__label">Unpaid This Cycle</span>
        </div>
        <div class="schedule-metric__value">{{ run.currency }} {{ summary.unpaid_total|money }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">{{ status_counts.get('not_paid', 0) }} pending</span>
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item">{{ status_counts.get('on_hold', 0) }} on hold</span>
        </div>
    </div>

    <div class="schedule-metric schedule-metric--danger {% if overdue_count > 0 %}schedule-metric--alert{% endif %}">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">üö®</span>
            <span class="schedule-metric__label">Overdue</span>
        </div>
        <div class="schedule-metric__value">{{ overdue_count }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">{{ run.currency }} {{ overdue_amount|money }}</span>
            {% if overdue_count > 0 %}
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item" style="color: #ef4444;">Action needed</span>
            {% else %}
            <span class="schedule-metric__divider">¬∑</span>
            <span class="schedule-metric__item">All current</span>
            {% endif %}
        </div>
    </div>

    <div class="schedule-metric schedule-metric--success">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">üí∞</span>
            <span class="schedule-metric__label">Lifetime Paid</span>
        </div>
        <div class="schedule-metric__value">{{ run.currency }} {{ summary.overall_paid|money }}</div>
        <div class="schedule-metric__breakdown">
            <span class="schedule-metric__item">All-time total</span>
        </div>
    </div>

    <div class="schedule-metric schedule-metric--neutral">
        <div class="schedule-metric__header">
            <span class="schedule-metric__icon">üìä</span>
            <span class="schedule-metric__label">Frequency Mix</span>
        </div>
        <div class="schedule-metric__value schedule-metric__value--compact">{{ payouts|length }}</div>
        <div class="schedule-metric__breakdown">
            {% for name, count in frequency_counts.items() %}
                <span class="schedule-metric__item">{{ name|title }}: {{ count }}</span>
                {% if not loop.last %}<span class="schedule-metric__divider">¬∑</span>{% endif %}
            {% else %}
                <span class="schedule-metric__item">No data</span>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Payouts Section -->
<section class="card" style="margin-top: 32px;">
    <div class="section-heading">
        <div>
            <h2><span class="section-icon">üìã</span> Payment Schedule</h2>
            <p style="color: #94a3b8; margin: 4px 0 0 0;">{{ payouts|length }} payment{{ 's' if payouts|length != 1 else '' }} in this cycle</p>
        </div>
    </div>

    <!-- Compact Filter Toolbar -->
    <div class="schedule-filter-toolbar">
        <div class="schedule-filter-toolbar__search">
            <input type="text" id="quick-search" placeholder="üîç Search by code, name..." 
                   onkeyup="filterPayoutTable()" 
                   class="filter-search-input">
        </div>
        
        <form class="schedule-filter-toolbar__filters" method="get" action="/schedules/{{ run.id }}">
            <input type="hidden" name="q" id="filter-q-hidden" value="{{ request.query_params.get('q','') if request and request.query_params else '' }}">
            <div class="filter-group-inline">
                <label for="filter-status">Status</label>
                <select id="filter-status" name="status" onchange="this.form.submit()" class="filter-select">
                    <option value="">All</option>
                    {% for option in status_options %}
                        <option value="{{ option }}" {% if filters.status == option %}selected{% endif %}>{{ option.replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>

            {# Code filter removed for single-run schedule view to simplify toolbar #}

            <div class="filter-group-inline">
                <label for="filter-frequency">Frequency</label>
                <select id="filter-frequency" name="frequency" onchange="this.form.submit()" class="filter-select">
                    <option value="">All</option>
                    {% for value in frequency_options %}
                        <option value="{{ value }}" {% if filters.frequency == value %}selected{% endif %}>{{ value|title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group-inline">
                <label for="filter-method">Method</label>
                <select id="filter-method" name="payment_method" onchange="this.form.submit()" class="filter-select">
                    <option value="">All</option>
                    {% for value in payment_methods %}
                        <option value="{{ value }}" {% if filters.payment_method == value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group-inline">
                <label for="filter-pay-date">Pay Date</label>
                <select id="filter-pay-date" name="pay_date" onchange="this.form.submit()" class="filter-select">
                    <option value="">All dates</option>
                    {% for option in pay_date_options %}
                        <option value="{{ option.value }}" {% if filters.pay_date == option.value %}selected{% endif %} {% if not option.available %}disabled{% endif %}>{{ option.label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            {% if filters.code or filters.status or filters.frequency or filters.payment_method or filters.pay_date %}
            <a class="filter-clear-button" href="/schedules/{{ run.id }}">
                <span>‚úï</span>
                <span>Clear</span>
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Status Filter Chips -->
    <div class="status-filter-chips" style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="status-chip-filter {% if not filters.status %}status-chip-filter--active{% endif %}" 
                onclick="filterByStatus('')" type="button">
            All ({{ payouts|length }})
        </button>
        {% if overdue_count > 0 %}
        <button class="status-chip-filter status-chip-filter--overdue" 
                onclick="filterByOverdue()" type="button">
            üö® Overdue ({{ overdue_count }})
        </button>
        {% endif %}
        {% for option in status_options %}
        <button class="status-chip-filter status-chip-filter--{{ option }} {% if filters.status == option %}status-chip-filter--active{% endif %}" 
                onclick="filterByStatus('{{ option }}')" type="button">
            {{ option.replace('_', ' ')|title }} ({{ status_counts.get(option, 0) }})
        </button>
        {% endfor %}
    </div>

    <div class="filter-toolbar__stats" id="filter-stats" style="margin-top: 16px; padding: 12px 0; border-top: 1px solid rgba(148, 163, 184, 0.08); color: #94a3b8; font-size: 14px;">
        <span>Showing <strong id="visible-count">{{ payouts|length }}</strong> of <strong>{{ payouts|length }}</strong> payments</span>
    </div>
    
    <!-- Modern Payouts Table -->
    <div class="data-table-wrapper" style="margin-top: 24px;">
        <table class="data-table schedule-payouts-table" id="payouts-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)" data-sortable="true" style="cursor: pointer; user-select: none;">Pay Date ‚ñº</th>
                    <th onclick="sortTable(1)" data-sortable="true" style="cursor: pointer; user-select: none;">Code ‚ñº</th>
                    <th onclick="sortTable(2)" data-sortable="true" style="cursor: pointer; user-select: none;">Working Name ‚ñº</th>
                    <th onclick="sortTable(3)" data-sortable="true" style="cursor: pointer; user-select: none;">Method ‚ñº</th>
                    <th onclick="sortTable(4)" data-sortable="true" style="cursor: pointer; user-select: none;">Frequency ‚ñº</th>
                    <th onclick="sortTable(5)" data-sortable="true" style="cursor: pointer; user-select: none;">Amount ‚ñº</th>
                    <th onclick="sortTable(6)" data-sortable="true" style="cursor: pointer; user-select: none; text-align: center;">Deductions ‚ñº</th>
                    <th onclick="sortTable(7)" data-sortable="true" style="cursor: pointer; user-select: none; text-align: center;">Status ‚ñº</th>
                    <th onclick="sortTable(8)" data-sortable="true" style="cursor: pointer; user-select: none; min-width: 200px;">Notes ‚ñº</th>
                    <th style="min-width: 120px;">Quick Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payout in payouts %}
                {% set is_overdue = payout.pay_date and payout.pay_date < today and payout.status in ['not_paid', 'on_hold'] %}
                <tr class="payout-row payout-row--{{ payout.status }} {% if is_overdue %}payout-row--overdue{% endif %}" 
                    data-payout-id="{{ payout.id }}"
                    data-code="{{ payout.code|lower }}"
                    data-name="{{ (payout.working_name or '')|lower }}"
                    data-status="{{ payout.status }}"
                    data-is-overdue="{{ 'true' if is_overdue else 'false' }}"
                    data-amount="{{ payout.amount or 0 }}">
                    {# Checkbox removed for single-run view #}
                    <td style="white-space: nowrap;">
                        <strong>{{ payout.pay_date|display_date }}</strong>
                        {% if is_overdue %}
                        <span class="overdue-badge" title="Payment is overdue">üö®</span>
                        {% endif %}
                    </td>
                    <td>
                        <span style="font-weight: 600; color: #60a5fa;">{{ payout.code }}</span>
                    </td>
                    <td>{{ payout.working_name or '‚Äî' }}</td>
                    <td>{{ payout.payment_method or '‚Äî' }}</td>
                    <td>
                        <span class="frequency-badge frequency-badge--{{ payout.payment_frequency }}">
                            {{ payout.payment_frequency|title if payout.payment_frequency else '‚Äî' }}
                        </span>
                    </td>
                    <td>
                        <strong style="font-size: 15px;">{{ run.currency }} {{ payout.amount|money }}</strong>
                    </td>
                    <td style="text-align: center;">
                        {% set deduction = advance_allocations.get(payout.id, 0) %}
                        {% if deduction > 0 %}
                        <span title="Cash advance deduction for this payout" style="color: #ef4444; font-weight: 600;">
                            -{{ run.currency }} {{ deduction|money }}
                        </span>
                        {% else %}
                        <span style="color: #475569;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        <span class="status-chip status-chip--{{ 'success' if payout.status == 'paid' else ('warning' if payout.status == 'not_paid' else 'danger') }}">
                            {{ payout.status.replace('_', ' ')|title }}
                        </span>
                        {% if is_overdue %}
                        <span class="overdue-label">OVERDUE</span>
                        {% endif %}
                    </td>
                    <td class="payout-note-cell">
                        {% if payout.notes %}
                        <span class="payout-note-text" title="{{ payout.notes }}">{{ payout.notes|replace('\n', ' ') }}</span>
                        {% else %}
                        <span class="payout-note-text payout-note-text--empty">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            {% if payout.status != 'paid' %}
                            <button class="action-button action-button--success" 
                                    onclick="quickUpdateStatus({{ payout.id }}, 'paid')" 
                                    title="Mark as Paid">
                                ‚úì
                            </button>
                            {% else %}
                            <button class="action-button action-button--neutral" 
                                    onclick="quickUpdateStatus({{ payout.id }}, 'not_paid')" 
                                    title="Unmark Paid">
                                ‚Ü∫
                            </button>
                            {% endif %}
                            {% if payout.status != 'on_hold' %}
                            <button class="action-button action-button--warning" 
                                    onclick="quickUpdateStatus({{ payout.id }}, 'on_hold')" 
                                    title="Put On Hold">
                                ‚è∏
                            </button>
                            {% else %}
                            <button class="action-button action-button--neutral" 
                                    onclick="quickUpdateStatus({{ payout.id }}, 'not_paid')" 
                                    title="Remove Hold">
                                ‚ñ∂
                            </button>
                            {% endif %}
                            <button class="action-button action-button--secondary" 
                                    onclick="toggleNotesRow({{ payout.id }})" 
                                    title="Edit Notes">
                                üìù
                            </button>
                        </div>
                    </td>
                </tr>
                <!-- Expandable Notes Row -->
                <tr class="notes-row" id="notes-row-{{ payout.id }}" style="display: none;">
                    <td colspan="9" style="padding: 0; background: rgba(15, 23, 42, 0.95);">
                        <div style="padding: 16px; border-top: 1px solid rgba(148, 163, 184, 0.1);">
                            <form method="post" action="/schedules/{{ run.id }}/payouts/{{ payout.id }}/note" 
                                                                    style="display: flex; gap: 12px; align-items: flex-start;">
                                                                <input type="hidden" name="redirect_to" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                                <div style="flex: 0 0 180px;">
                                    <label style="display: block; margin-bottom: 6px; color: #cbd5e1; font-weight: 600; font-size: 13px;">Payment Status</label>
                                    <select name="status" 
                                            style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; font-size: 14px;">
                                        {% for option in status_options %}
                                            <option value="{{ option }}" {% if payout.status == option %}selected{% endif %}>
                                                {{ option.replace('_', ' ')|title }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 6px; color: #cbd5e1; font-weight: 600; font-size: 13px;">Notes</label>
                                    <textarea name="notes" 
                                              placeholder="Add context, tracking info, or payment details..." 
                                              style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; min-height: 80px; font-family: inherit; resize: vertical; font-size: 14px;">{{ payout.notes or '' }}</textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; padding-top: 28px;">
                                    <button class="button button--primary button--compact" type="submit">
                                        <span>üíæ</span>
                                        <span>Save</span>
                                    </button>
                                    <button class="button secondary button--compact" type="button" 
                                            onclick="toggleNotesRow({{ payout.id }})">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td class="empty-state" colspan="8">No payouts match the current filters.</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background: rgba(59, 130, 246, 0.05); font-weight: 600;">
                    <th colspan="5" style="text-align: right; padding: 16px;">Cycle Total</th>
                    <th style="font-size: 16px; color: #3b82f6;">{{ run.currency }} <span id="visible-total">{{ payout_total|money }}</span></th>
                    <th colspan="4"></th>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <!-- Sticky Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulk-actions-bar" style="display: none;">
        <div class="bulk-actions-bar__content">
            <div class="bulk-actions-bar__info">
                <span class="bulk-actions-bar__icon">‚òëÔ∏è</span>
                <span class="bulk-actions-bar__text">
                    <strong id="selected-count">0</strong> payment<span id="selected-plural">s</span> selected
                </span>
            </div>
            <form method="post" action="/schedules/{{ run.id }}/payouts/bulk-update" id="bulk-form" 
                  style="display: flex; gap: 12px; align-items: center;">
                <input type="hidden" id="bulk-payout-ids" name="payout_ids" value="">
                <input type="hidden" name="redirect_to" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label for="bulk-status" style="color: #e2e8f0; font-weight: 600; font-size: 14px;">Update Status:</label>
                    <select id="bulk-status" name="status" 
                            style="padding: 8px 12px; background: rgba(15, 23, 42, 0.9); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; font-size: 14px;">
                        {% for option in status_options %}
                            <option value="{{ option }}">{{ option.replace('_', ' ')|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="button button--primary button--compact" type="submit">
                    <span>‚úì</span>
                    <span>Apply</span>
                </button>
                <button class="button secondary button--compact" type="button" onclick="cancelBulkUpdate()">
                    <span>‚úï</span>
                    <span>Cancel</span>
                </button>
            </form>
        </div>
    </div>
</section>

<!-- Collapsible Validation Section -->
{% if validations|length > 0 %}
<section class="card validation-section" id="validation-section" style="margin-top: 32px; display: none;">
    <div class="section-heading">
        <div>
            <h2><span class="section-icon">‚ö†Ô∏è</span> Validation Issues</h2>
            <p style="color: #94a3b8; margin: 4px 0 0 0;">{{ validations|length }} issue{{ 's' if validations|length != 1 else '' }} detected</p>
        </div>
    </div>
    <div class="data-table-wrapper" style="margin-top: 16px;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 100px;">Severity</th>
                    <th style="width: 150px;">Model</th>
                    <th>Issue</th>
                </tr>
            </thead>
            <tbody>
                {% for item in validations %}
                <tr>
                    <td>
                        <span class="status-chip status-chip--{{ 'danger' if item.severity == 'error' else 'warning' }}">
                            {{ item.severity|title }}
                        </span>
                    </td>
                    <td>
                        <span style="font-weight: 600; color: #60a5fa;">{{ item.model.code if item.model else '‚Äî' }}</span>
                    </td>
                    <td style="color: #cbd5e1;">{{ item.issue }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<script>
// Toggle select all checkboxes
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.payout-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkSection();
}

// Update bulk actions bar visibility and count
function updateBulkSection() {
    const checkboxes = document.querySelectorAll('.payout-checkbox:checked');
    const bulkBar = document.getElementById('bulk-actions-bar');
    if (!bulkBar) {
        return;
    }
    const count = checkboxes.length;
    
    if (count > 0) {
        bulkBar.style.display = 'block';
        const selectedCount = document.getElementById('selected-count');
        const selectedPlural = document.getElementById('selected-plural');
        const bulkIdsInput = document.getElementById('bulk-payout-ids');

        if (selectedCount) {
            selectedCount.textContent = count;
        }
        if (selectedPlural) {
            selectedPlural.textContent = count === 1 ? '' : 's';
        }
        if (bulkIdsInput) {
            const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
            bulkIdsInput.value = ids;
        }
    } else {
        bulkBar.style.display = 'none';
    }
}

// Cancel bulk update
function cancelBulkUpdate() {
    document.querySelectorAll('.payout-checkbox').forEach(cb => cb.checked = false);
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
        selectAll.checked = false;
    }
    updateBulkSection();
}

// Quick status update via button
function quickUpdateStatus(payoutId, status) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/schedules/{{ run.id }}/payouts/${payoutId}/note`;
    
    const statusInput = document.createElement('input');
    statusInput.type = 'hidden';
    statusInput.name = 'status';
    statusInput.value = status;
    
    const notesInput = document.createElement('input');
    notesInput.type = 'hidden';
    notesInput.name = 'notes';
    notesInput.value = '';
    
    const redirectInput = document.createElement('input');
    redirectInput.type = 'hidden';
    redirectInput.name = 'redirect_to';
    redirectInput.value = window.location.pathname + window.location.search;

    form.appendChild(statusInput);
    form.appendChild(notesInput);
    form.appendChild(redirectInput);
    document.body.appendChild(form);
    form.submit();
}

// Toggle notes row for editing
function toggleNotesRow(payoutId) {
    const notesRow = document.getElementById(`notes-row-${payoutId}`);
    if (!notesRow) {
        return;
    }
    if (notesRow.style.display === 'none') {
        // Hide all other notes rows
        document.querySelectorAll('.notes-row').forEach(row => {
            row.style.display = 'none';
        });
        notesRow.style.display = '';
    } else {
        notesRow.style.display = 'none';
    }
}

// Toggle validation section
function toggleValidation() {
    const section = document.getElementById('validation-section');
    const toggleText = document.getElementById('validation-toggle-text');
    if (!section || !toggleText) {
        return;
    }
    if (section.style.display === 'none') {
        section.style.display = 'block';
        toggleText.textContent = 'Hide Details';
    } else {
        section.style.display = 'none';
        toggleText.textContent = 'Show Details';
    }
}

// Filter by status (chip buttons)
function filterByStatus(status) {
    const url = new URL(window.location.href);
    if (status) {
        url.searchParams.set('status', status);
    } else {
        url.searchParams.delete('status');
    }
    window.location.href = url.toString();
}

// Filter by overdue (client-side)
function filterByOverdue() {
    const searchInput = document.getElementById('quick-search');
    if (searchInput) {
        searchInput.value = '';
    }
    
    const tableBody = document.querySelector('#payouts-table tbody');
    if (!tableBody) {
        return;
    }
    const rows = Array.from(tableBody.querySelectorAll('tr.payout-row'));
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const isOverdue = row.getAttribute('data-is-overdue') === 'true';
        
        if (isOverdue) {
            row.style.display = '';
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow && notesRow.style.display !== 'none') {
                notesRow.style.display = '';
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow) {
                notesRow.style.display = 'none';
            }
        }
    });
    
    const visibleCountEl = document.getElementById('visible-count');
    if (visibleCountEl) {
        visibleCountEl.textContent = visibleCount;
    }
    // Clear quick search and persist removal
    const hiddenQ = document.getElementById('filter-q-hidden');
    if (searchInput) searchInput.value = '';
    if (hiddenQ) hiddenQ.value = '';
    const url = new URL(window.location.href);
    url.searchParams.delete('q');
    history.replaceState(null, '', url.toString());
    recomputeVisibleTotal();
}

// Client-side quick search filter
function filterPayoutTable() {
    const searchInput = document.getElementById('quick-search');
    const tableBody = document.querySelector('#payouts-table tbody');
    if (!searchInput || !tableBody) {
        return;
    }
    const searchTerm = searchInput.value.toLowerCase();
    const rows = Array.from(tableBody.querySelectorAll('tr.payout-row'));
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const code = row.getAttribute('data-code') || '';
        const name = row.getAttribute('data-name') || '';
        
        const matchesSearch = !searchTerm || 
            code.includes(searchTerm) || 
            name.includes(searchTerm);
        
        if (matchesSearch) {
            row.style.display = '';
            // Also show the associated notes row if it was visible
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow && notesRow.style.display !== 'none') {
                notesRow.style.display = '';
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Hide associated notes row
            const payoutId = row.getAttribute('data-payout-id');
            const notesRow = document.getElementById(`notes-row-${payoutId}`);
            if (notesRow) {
                notesRow.style.display = 'none';
            }
        }
    });
    
    // Update count
    const visibleCountEl = document.getElementById('visible-count');
    if (visibleCountEl) {
        visibleCountEl.textContent = visibleCount;
    }
    // Persist quick search to URL and hidden form field
    const hiddenQ = document.getElementById('filter-q-hidden');
    if (hiddenQ) hiddenQ.value = searchTerm;
    const url = new URL(window.location.href);
    if (searchTerm) {
        url.searchParams.set('q', searchTerm);
    } else {
        url.searchParams.delete('q');
    }
    history.replaceState(null, '', url.toString());
    recomputeVisibleTotal();
}

// Table sorting
let sortDirection = {};

function sortTable(columnIndex) {
    const table = document.querySelector('#payouts-table');
    if (!table) {
        return;
    }
    const tbody = table.querySelector('tbody');
    if (!tbody) {
        return;
    }
    let rows = Array.from(tbody.querySelectorAll('tr.payout-row'));

    if (rows.length === 0) {
        return;
    }

    // Toggle sort direction
    const prev = sortDirection[columnIndex] === true;
    const isAscending = !prev;
    sortDirection = {};
    sortDirection[columnIndex] = isAscending;

    // Sort rows
    rows.sort((rowA, rowB) => {
        const cellA = (rowA.cells[columnIndex] && rowA.cells[columnIndex].textContent || '').trim();
        const cellB = (rowB.cells[columnIndex] && rowB.cells[columnIndex].textContent || '').trim();

        // Date sort (handles display format)
        if (columnIndex === 0) {
            const parse = s => {
                const parts = s.split('/');
                if (parts.length === 3) return new Date(`${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`);
                return new Date(s);
            };
            const dateA = parse(cellA);
            const dateB = parse(cellB);
            return isAscending ? dateA - dateB : dateB - dateA;
        }

        // Numeric sort (Amount column)
        const numA = parseFloat(cellA.replace(/[^\d.-]/g, ''));
        const numB = parseFloat(cellB.replace(/[^\d.-]/g, ''));
        if (!isNaN(numA) && !isNaN(numB)) {
            return isAscending ? numA - numB : numB - numA;
        }

        // String sort
        return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });

    // Reappend sorted rows (with their notes rows)
    rows.forEach(row => {
        tbody.appendChild(row);
        const payoutId = row.getAttribute('data-payout-id');
        const notesRow = document.getElementById(`notes-row-${payoutId}`);
        if (notesRow) {
            tbody.appendChild(notesRow);
        }
    });

    // Update header indicators
    document.querySelectorAll('#payouts-table thead th').forEach((th, idx) => {
        if (th.dataset.sortable !== 'true') {
            return;
        }
        const base = th.textContent.replace(/\s*[‚ñ≤‚ñº]\s*$/, '').trim();
        if (idx === columnIndex) {
            th.textContent = base + (isAscending ? ' ‚ñ≤' : ' ‚ñº');
        } else {
            th.textContent = base + ' ‚ñº';
        }
    });
}

// Auto-filter on page load if URL parameter is present
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const showFilter = urlParams.get('show');
    const persistedQ = urlParams.get('q') || '';
    
    if (showFilter === 'overdue') {
        // Trigger the overdue filter
        filterByOverdue();
        
        // Scroll to the table
        const table = document.getElementById('payouts-table');
        if (table) {
            setTimeout(() => {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }
    // Reapply persisted quick search
    if (persistedQ) {
        const searchInput = document.getElementById('quick-search');
        const hiddenQ = document.getElementById('filter-q-hidden');
        if (searchInput) searchInput.value = persistedQ;
        if (hiddenQ) hiddenQ.value = persistedQ;
        filterPayoutTable();
    }
    // Compute initial visible total on load as well
    recomputeVisibleTotal();
    // Ensure notes forms redirect back including current quick search and filters
    document.querySelectorAll('form[action$="/note"]').forEach(form => {
        form.addEventListener('submit', function() {
            const redirectInput = form.querySelector('input[name="redirect_to"]');
            if (redirectInput) {
                redirectInput.value = window.location.pathname + window.location.search;
            }
        });
    });
});

// Money formatting helper (US style, 2 decimals)
function formatMoney(value) {
    try {
        return (Number(value) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } catch (e) {
        const n = Math.round((Number(value) || 0) * 100) / 100;
        return n.toFixed(2);
    }
}

// Recompute visible total based on currently visible rows
function recomputeVisibleTotal() {
    const rows = Array.from(document.querySelectorAll('#payouts-table tbody tr.payout-row'));
    if (!rows.length) {
        const el = document.getElementById('visible-total');
        if (el) el.textContent = formatMoney(0);
        return;
    }
    let total = 0;
    rows.forEach(row => {
        if (row.style.display === 'none') return;
        const amount = parseFloat(row.getAttribute('data-amount') || '0');
        if (!isNaN(amount)) total += amount;
    });
    const totalEl = document.getElementById('visible-total');
    if (totalEl) {
        totalEl.textContent = formatMoney(total);
    }
}
</script>

<style>
/* Schedule payouts table header and column sizing */
.data-table.schedule-payouts-table {
    table-layout: auto; /* allow natural column resize to fit headers */
}
.data-table.schedule-payouts-table thead th {
    white-space: nowrap;        /* keep header text on one line */
    overflow: hidden;           /* prevent wrapping overflow */
    text-overflow: ellipsis;    /* show ellipsis if constrained */
    vertical-align: bottom;
}
/* Column widths tuned to keep headers inline without wrapping */
.data-table.schedule-payouts-table th:nth-child(1),
.data-table.schedule-payouts-table td:nth-child(1) { /* Pay Date */
    width: 120px;
}
.data-table.schedule-payouts-table th:nth-child(2),
.data-table.schedule-payouts-table td:nth-child(2) { /* Code */
    width: 110px;
}
.data-table.schedule-payouts-table th:nth-child(3),
.data-table.schedule-payouts-table td:nth-child(3) { /* Working Name */
    width: auto;
}
.data-table.schedule-payouts-table th:nth-child(4),
.data-table.schedule-payouts-table td:nth-child(4) { /* Method */
    width: 140px;
}
.data-table.schedule-payouts-table th:nth-child(5),
.data-table.schedule-payouts-table td:nth-child(5) { /* Frequency */
    width: 130px;
}
.data-table.schedule-payouts-table th:nth-child(6),
.data-table.schedule-payouts-table td:nth-child(6) { /* Amount */
    width: 140px;
}
.data-table.schedule-payouts-table th:nth-child(7),
.data-table.schedule-payouts-table td:nth-child(7) { /* Deductions */
    width: 130px;
}
.data-table.schedule-payouts-table th:nth-child(8),
.data-table.schedule-payouts-table td:nth-child(8) { /* Status */
    width: 130px;
}
.data-table.schedule-payouts-table th:nth-child(9),
.data-table.schedule-payouts-table td:nth-child(9) { /* Notes */
    width: 240px;
}
.data-table.schedule-payouts-table th:nth-child(10),
.data-table.schedule-payouts-table td:nth-child(10) { /* Quick Actions */
    width: 140px;
}

/* Schedule Metrics Dashboard */
.schedule-metrics-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.schedule-metric {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s ease;
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35);
}

.schedule-metric:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.5);
}

.schedule-metric--primary {
    border-left: 4px solid #3b82f6;
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--success {
    border-left: 4px solid #22c55e;
    background: linear-gradient(145deg, rgba(34, 197, 94, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--warning {
    border-left: 4px solid #eab308;
    background: linear-gradient(145deg, rgba(234, 179, 8, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--neutral {
    border-left: 4px solid #94a3b8;
}

.schedule-metric--danger {
    border-left: 4px solid #ef4444;
    background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(15, 23, 42, 0.9));
}

.schedule-metric--alert {
    animation: pulse-alert 2s ease-in-out infinite;
}

@keyframes pulse-alert {
    0%, 100% {
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3);
    }
    50% {
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.6);
    }
}

.schedule-metric__header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.schedule-metric__icon {
    font-size: 20px;
}

.schedule-metric__label {
    font-size: 13px;
    font-weight: 500;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.schedule-metric__value {
    font-size: 32px;
    font-weight: 700;
    color: #f8fafc;
    margin-bottom: 8px;
}

.schedule-metric__value--compact {
    font-size: 28px;
}

.schedule-metric__breakdown {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #94a3b8;
    flex-wrap: wrap;
}

.schedule-metric__item {
    color: #cbd5e1;
}

.schedule-metric__divider {
    color: #475569;
}

/* Alert Banner */
.alert-banner {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.3);
}

.alert-banner--warning {
    border-left: 4px solid #eab308;
    background: linear-gradient(145deg, rgba(234, 179, 8, 0.15), rgba(15, 23, 42, 0.9));
}

.alert-banner__icon {
    font-size: 24px;
}

.alert-banner__content {
    flex: 1;
}

.alert-banner__title {
    font-weight: 600;
    color: #f8fafc;
    margin-bottom: 4px;
}

.alert-banner__message {
    font-size: 14px;
    color: #94a3b8;
}

.alert-banner__action {
    padding: 8px 16px;
    background: rgba(59, 130, 246, 0.15);
    color: #60a5fa;
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.alert-banner__action:hover {
    background: rgba(59, 130, 246, 0.25);
}

/* Filter Toolbar */
.schedule-filter-toolbar {
    display: flex;
    gap: 16px;
    margin-top: 20px;
    padding: 20px;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 12px;
    align-items: flex-end;
}

.schedule-filter-toolbar__search {
    flex: 1;
    min-width: 250px;
}

.filter-search-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 8px;
    font-size: 14px;
    background: rgba(15, 23, 42, 0.8);
    color: #f8fafc;
    transition: all 0.2s ease;
}

.filter-search-input:focus {
    outline: none;
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.schedule-filter-toolbar__filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
    flex: 2;
}

.filter-group-inline {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 140px;
}

.filter-group-inline label {
    font-size: 12px;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-select {
    padding: 10px 12px;
    background: rgba(15, 23, 42, 0.8);
    color: #f8fafc;
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-select:hover {
    border-color: rgba(148, 163, 184, 0.3);
    background: rgba(15, 23, 42, 0.9);
}

.filter-select:focus {
    outline: none;
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.filter-clear-button {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    white-space: nowrap;
}

.filter-clear-button:hover {
    background: rgba(239, 68, 68, 0.25);
    border-color: rgba(239, 68, 68, 0.4);
    transform: translateY(-1px);
}

/* Status Filter Chips */
.status-chip-filter {
    padding: 8px 16px;
    background: rgba(15, 23, 42, 0.6);
    color: #cbd5e1;
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.status-chip-filter:hover {
    background: rgba(15, 23, 42, 0.8);
    border-color: rgba(148, 163, 184, 0.3);
}

.status-chip-filter--active {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    border-color: rgba(59, 130, 246, 0.4);
}

.status-chip-filter--paid {
    border-color: rgba(34, 197, 94, 0.3);
}

.status-chip-filter--paid.status-chip-filter--active {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.4);
}

.status-chip-filter--not_paid {
    border-color: rgba(234, 179, 8, 0.3);
}

.status-chip-filter--not_paid.status-chip-filter--active {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
    border-color: rgba(234, 179, 8, 0.4);
}

.status-chip-filter--on_hold {
    border-color: rgba(239, 68, 68, 0.3);
}

.status-chip-filter--on_hold.status-chip-filter--active {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.4);
}

.status-chip-filter--overdue {
    border-color: rgba(239, 68, 68, 0.4);
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    font-weight: 700;
    animation: pulse-border 2s ease-in-out infinite;
}

.status-chip-filter--overdue:hover {
    background: rgba(239, 68, 68, 0.3);
}

@keyframes pulse-border {
    0%, 100% {
        border-color: rgba(239, 68, 68, 0.4);
    }
    50% {
        border-color: rgba(239, 68, 68, 0.7);
    }
}

/* Payout Table Rows */
.payout-row {
    transition: background-color 0.15s ease;
}

.payout-row:hover {
    background-color: rgba(30, 41, 59, 0.5) !important;
}

.payout-row--paid {
    background: rgba(34, 197, 94, 0.05);
}

.payout-row--not_paid {
    background: rgba(234, 179, 8, 0.05);
}

.payout-row--on_hold {
    background: rgba(239, 68, 68, 0.05);
}

.payout-row--overdue {
    background: rgba(239, 68, 68, 0.15) !important;
    border-left: 3px solid #ef4444;
}

.payout-row--overdue:hover {
    background-color: rgba(239, 68, 68, 0.25) !important;
}

.overdue-badge {
    display: inline-block;
    margin-left: 8px;
    font-size: 16px;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

.overdue-label {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 8px;
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.notes-row {
    background: rgba(15, 23, 42, 0.95) !important;
}

.payout-note-cell {
    color: #cbd5e1;
    max-width: 240px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.payout-note-text--empty {
    color: #475569;
    font-style: italic;
}

/* Action Buttons */
.action-button {
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    background: rgba(15, 23, 42, 0.6);
    color: #cbd5e1;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 14px;
}

.action-button:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.action-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.action-button--success {
    border-color: rgba(34, 197, 94, 0.3);
    color: #22c55e;
}

.action-button--success:hover:not(:disabled) {
    background: rgba(34, 197, 94, 0.15);
    border-color: rgba(34, 197, 94, 0.5);
}

.action-button--warning {
    border-color: rgba(234, 179, 8, 0.3);
    color: #eab308;
}

.action-button--warning:hover:not(:disabled) {
    background: rgba(234, 179, 8, 0.15);
    border-color: rgba(234, 179, 8, 0.5);
}

.action-button--secondary {
    border-color: rgba(148, 163, 184, 0.2);
    color: #94a3b8;
}

.action-button--secondary:hover:not(:disabled) {
    background: rgba(148, 163, 184, 0.1);
    border-color: rgba(148, 163, 184, 0.3);
}

.action-button--neutral {
    border-color: rgba(148, 163, 184, 0.3);
    color: #cbd5e1;
}

.action-button--neutral:hover:not(:disabled) {
    background: rgba(148, 163, 184, 0.15);
    border-color: rgba(148, 163, 184, 0.4);
}

/* Bulk Actions Bar */
.bulk-actions-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.98));
    border-top: 1px solid rgba(59, 130, 246, 0.3);
    box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5);
    padding: 16px 24px;
    z-index: 100;
    backdrop-filter: blur(10px);
}

.bulk-actions-bar__content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
}

.bulk-actions-bar__info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.bulk-actions-bar__icon {
    font-size: 24px;
}

.bulk-actions-bar__text {
    font-size: 15px;
    color: #e2e8f0;
}

.bulk-actions-bar__text strong {
    color: #60a5fa;
    font-size: 18px;
}

/* Responsive Styles */
@media (max-width: 1024px) {
    .schedule-filter-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .schedule-filter-toolbar__search {
        min-width: 0;
    }
    
    .schedule-filter-toolbar__filters {
        flex-direction: column;
        align-items: stretch;
        flex: 1;
    }
    
    .filter-group-inline {
        min-width: 0;
        width: 100%;
    }
}

@media (max-width: 640px) {
    /* Hero metrics on mobile */
    .schedule-metrics-dashboard {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    /* Page header on mobile */
    .page-header .header-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }
    
    .page-header .header-actions .button {
        width: 100%;
        justify-content: center;
    }
    
    /* Section heading adjustments */
    .section-heading {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    /* Filter toolbar on mobile */
    .schedule-filter-toolbar {
        padding: 12px;
    }
    
    /* Status filter chips wrap properly */
    .status-filter-chips {
        gap: 6px !important;
    }
    
    .status-chip-filter {
        font-size: 12px;
        padding: 6px 10px;
    }
    
    /* Make table scrollable on mobile */
    .data-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-left: -16px;
        margin-right: -16px;
        padding-left: 16px;
        padding-right: 16px;
    }
    
    .data-table {
        min-width: 900px;
        font-size: 13px;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 6px;
    }
    
    /* Compact action buttons */
    .action-button {
        padding: 4px 8px;
        font-size: 11px;
    }
    
    /* Filter clear button */
    .filter-clear-button {
        width: 100%;
        justify-content: center;
    }
}
</style>

{% endblock %}
