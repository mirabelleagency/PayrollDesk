{% extends "base.html" %}
{% block title %}{{ 'Edit Model' if action == 'edit' else 'Add Model' }} · Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">{{ 'Edit Model' if action == 'edit' else 'Add Model' }}</h1>
        <p>Capture roster information used for automated payroll scheduling.</p>
    </div>
</section>

<section class="card card--form">
    <form class="form form--wide" method="post">
        <div class="form-grid two-column">
            <div class="form-row">
                <label for="status">Status</label>
                <select id="status" name="status" required>
                    {% set status_value = model.status if model else 'Active' %}
                    <option value="Active" {% if status_value == 'Active' %}selected{% endif %}>Active</option>
                    <option value="Inactive" {% if status_value == 'Inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="form-row">
                <label for="code">Code <span class="required-badge">Required</span></label>
                <input id="code" name="code" type="text" required value="{{ model.code if model else '' }}" />
            </div>
            <div class="form-row">
                <label for="real_name">Real Name <span class="required-badge">Required</span></label>
                <input id="real_name" name="real_name" type="text" required value="{{ model.real_name if model else '' }}" />
            </div>
            <div class="form-row">
                <label for="working_name">Working Name <span class="required-badge">Required</span></label>
                <input id="working_name" name="working_name" type="text" required value="{{ model.working_name if model else '' }}" />
            </div>
            <div class="form-row">
                <label for="start_date">Start Date <span class="required-badge">Required</span></label>
                <input id="start_date" name="start_date" type="date" required value="{{ model.start_date if model else '' }}" />
            </div>
            <div class="form-row">
                <label for="payment_method">Payment Method</label>
                <input id="payment_method" name="payment_method" type="text" required value="{{ model.payment_method if model else '' }}" />
            </div>
            <div class="form-row">
                <label for="payment_frequency">Frequency <span class="required-badge">Required</span></label>
                {% set freq_value = model.payment_frequency if model else 'weekly' %}
                <select id="payment_frequency" name="payment_frequency" required>
                    <option value="weekly" {% if freq_value == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="biweekly" {% if freq_value == 'biweekly' %}selected{% endif %}>Biweekly</option>
                    <option value="monthly" {% if freq_value == 'monthly' %}selected{% endif %}>Monthly</option>
                </select>
            </div>
            <div class="form-row">
                <label for="amount_monthly">Monthly Amount (USD) <span class="required-badge">Required</span></label>
                <input id="amount_monthly" name="amount_monthly" type="number" step="0.01" min="0" required value="{{ '%.2f'|format(model.amount_monthly) if model else '' }}" />
            </div>
        </div>

        {% set adjustments = model.compensation_adjustments if model and model.compensation_adjustments else [] %}
        {% set adjustments_count = adjustments|length %}
        {% set latest_adjustment = adjustments[-1] if adjustments_count else None %}

        <details class="adjustments-panel" data-adjustments-panel {% if adjustments_count %}open{% endif %}>
            <summary class="adjustments-summary">
                <span class="adjustments-summary-title">Compensation Adjustments</span>
                <span class="adjustments-summary-meta">
                    <span class="adjustments-chip" data-adjustments-count>
                        {% if adjustments_count %}
                            {{ adjustments_count }} scheduled
                        {% else %}
                            None scheduled
                        {% endif %}
                    </span>
                    <span class="adjustments-summary-text" data-adjustments-latest>
                        {% if adjustments_count and latest_adjustment %}
                            Latest {{ latest_adjustment.effective_date|display_date }} · ${{ '%.2f'|format(latest_adjustment.amount_monthly) }}
                        {% endif %}
                    </span>
                </span>
            </summary>
            <div class="adjustments-body">
                <p class="form-hint">Capture raises that take effect after the model start date. Leave blank to skip.</p>
                <div class="adjustments-list" data-adjustments>
                    {% if adjustments %}
                        {% for adjustment in adjustments %}
                        <div class="adjustment-row">
                            <div class="form-row">
                                <label for="adjustment_date_{{ loop.index }}">Effective Date</label>
                                <input id="adjustment_date_{{ loop.index }}" name="adjustment_effective_dates" type="date" required value="{{ adjustment.effective_date.strftime('%Y-%m-%d') }}" />
                            </div>
                            <div class="form-row">
                                <label for="adjustment_amount_{{ loop.index }}">Monthly Amount</label>
                                <input id="adjustment_amount_{{ loop.index }}" name="adjustment_amounts" type="number" step="0.01" min="0.01" required value="{{ '%.2f'|format(adjustment.amount_monthly) }}" />
                            </div>
                            <div class="form-row">
                                <label for="adjustment_notes_{{ loop.index }}">Notes (Optional)</label>
                                <input id="adjustment_notes_{{ loop.index }}" name="adjustment_notes" type="text" value="{{ adjustment.notes or '' }}" placeholder="e.g., Performance raise" />
                            </div>
                            <button type="button" class="button tertiary" data-remove-adjustment>Remove</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="adjustment-row">
                            <div class="form-row">
                                <label for="adjustment_date_1">Effective Date</label>
                                <input id="adjustment_date_1" name="adjustment_effective_dates" type="date" />
                            </div>
                            <div class="form-row">
                                <label for="adjustment_amount_1">Monthly Amount</label>
                                <input id="adjustment_amount_1" name="adjustment_amounts" type="number" step="0.01" min="0.01" />
                            </div>
                            <div class="form-row">
                                <label for="adjustment_notes_1">Notes (Optional)</label>
                                <input id="adjustment_notes_1" name="adjustment_notes" type="text" placeholder="e.g., Performance raise" />
                            </div>
                            <button type="button" class="button tertiary" data-remove-adjustment>Remove</button>
                        </div>
                    {% endif %}
                </div>
                <div class="adjustments-toolbar">
                    <button type="button" class="button secondary" id="add-adjustment">Add Adjustment</button>
                    <p class="form-hint">Effective date must be on or after the model start date. Rows without both a date and amount are ignored.</p>
                </div>
            </div>
        </details>

        <div class="form-row">
            <label for="crypto_wallet">Crypto Wallet Address (Optional)</label>
            <input id="crypto_wallet" name="crypto_wallet" type="text" value="{{ model.crypto_wallet if model else '' }}" placeholder="e.g., 0x742d35Cc6634C0532925a3b844Bc9e7595f42e" />
        </div>
        <div class="form-actions form-actions--end">
            <button class="button" type="submit">Save</button>
            <a class="button secondary" href="/models">Cancel</a>
        </div>
    </form>
</section>
<template id="adjustment-row-template">
    <div class="adjustment-row">
        <div class="form-row">
            <label>Effective Date</label>
            <input name="adjustment_effective_dates" type="date" required />
        </div>
        <div class="form-row">
            <label>Monthly Amount</label>
            <input name="adjustment_amounts" type="number" step="0.01" min="0.01" required />
        </div>
        <div class="form-row">
            <label>Notes (Optional)</label>
            <input name="adjustment_notes" type="text" placeholder="e.g., Performance raise" />
        </div>
        <button type="button" class="button tertiary" data-remove-adjustment>Remove</button>
    </div>
</template>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const panel = document.querySelector('[data-adjustments-panel]');
    const container = panel ? panel.querySelector('[data-adjustments]') : null;
    const addButton = document.getElementById('add-adjustment');
    const template = document.getElementById('adjustment-row-template');
    const countDisplay = panel ? panel.querySelector('[data-adjustments-count]') : null;
    const latestDisplay = panel ? panel.querySelector('[data-adjustments-latest]') : null;

    if (!panel || !container || !addButton || !template) {
        return;
    }

    const formatDate = (value) => {
        if (!value) {
            return '';
        }
        const parts = value.split('-').map(Number);
        if (parts.length !== 3 || parts.some((part) => Number.isNaN(part))) {
            return '';
        }
        const [year, month, day] = parts;
        const isoDate = new Date(Date.UTC(year, month - 1, day));
        return isoDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const updateSummary = () => {
        if (!countDisplay) {
            return;
        }
        const rows = Array.from(container.querySelectorAll('.adjustment-row'));
        const validRows = rows
            .map((row) => {
                const dateInput = row.querySelector('input[name="adjustment_effective_dates"]');
                const amountInput = row.querySelector('input[name="adjustment_amounts"]');
                return {
                    date: dateInput ? dateInput.value : '',
                    amount: amountInput ? parseFloat(amountInput.value) : NaN,
                };
            })
            .filter((entry) => entry.date && Number.isFinite(entry.amount));

        if (!validRows.length) {
            countDisplay.textContent = 'None scheduled';
            if (latestDisplay) {
                latestDisplay.textContent = '';
            }
            return;
        }

        validRows.sort((a, b) => a.date.localeCompare(b.date));
        const latest = validRows[validRows.length - 1];
        countDisplay.textContent = `${validRows.length} scheduled`;
        if (latestDisplay) {
            const formattedDate = formatDate(latest.date);
            const formattedAmount = Number.isFinite(latest.amount) ? `$${latest.amount.toFixed(2)}` : '';
            const details = [formattedDate, formattedAmount].filter(Boolean).join(' ');
            latestDisplay.textContent = details ? `Latest ${details}` : '';
        }
    };

    const syncRemoveButtons = () => {
        const rows = container.querySelectorAll('.adjustment-row');
        rows.forEach((row) => {
            const removeButton = row.querySelector('[data-remove-adjustment]');
            if (removeButton) {
                removeButton.disabled = rows.length === 1;
            }
        });
        updateSummary();
    };

    addButton.addEventListener('click', () => {
        const clone = template.content.firstElementChild.cloneNode(true);
        container.appendChild(clone);
        syncRemoveButtons();
    });

    container.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-remove-adjustment]');
        if (!trigger) {
            return;
        }
        const rows = container.querySelectorAll('.adjustment-row');
        if (rows.length <= 1) {
            return;
        }
        trigger.closest('.adjustment-row').remove();
        syncRemoveButtons();
    });

    container.addEventListener('input', updateSummary);

    syncRemoveButtons();
});
</script>
{% endblock %}
