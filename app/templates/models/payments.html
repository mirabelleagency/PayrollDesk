{% extends "base.html" %}
{% block title %}All Model Payments ¬∑ Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">üí≥ All Model Payments</h1>
        <p>Comprehensive payment tracking across all registered models</p>
    </div>
    <div class="header-actions">
        <a class="button secondary" href="/models">
            <span>‚Üê Back to Models</span>
        </a>
        <button class="button button--primary" onclick="exportPaymentsCSV()">
            <span>üì•</span>
            <span>Export to CSV</span>
        </button>
    </div>
</section>

<!-- Financial Summary Dashboard -->
<section class="payment-metrics-dashboard">
    <div class="payment-metric payment-metric--primary">
        <div class="payment-metric__header">
            <span class="payment-metric__icon">üí∞</span>
            <span class="payment-metric__label">Total Payments</span>
        </div>
        <div class="payment-metric__value">USD {{ total_amount|money }}</div>
        <div class="payment-metric__breakdown">
            <span class="payment-metric__item">{{ all_payments|length }} payments</span>
        </div>
    </div>

    <div class="payment-metric payment-metric--success">
        <div class="payment-metric__header">
            <span class="payment-metric__icon">‚úÖ</span>
            <span class="payment-metric__label">Paid</span>
        </div>
        <div class="payment-metric__value">USD {{ paid_amount|money }}</div>
        <div class="payment-metric__breakdown">
            <span class="payment-metric__item">{{ status_counts.get('paid', 0) }} payments</span>
            <span class="payment-metric__divider">¬∑</span>
            <span class="payment-metric__item">{{ '%.1f'|format((paid_amount / total_amount * 100) if total_amount > 0 else 0) }}%</span>
        </div>
    </div>

    <div class="payment-metric payment-metric--warning">
        <div class="payment-metric__header">
            <span class="payment-metric__icon">‚è≥</span>
            <span class="payment-metric__label">Outstanding</span>
        </div>
        <div class="payment-metric__value">USD {{ unpaid_amount|money }}</div>
        <div class="payment-metric__breakdown">
            <span class="payment-metric__item">{{ status_counts.get('not_paid', 0) + status_counts.get('on_hold', 0) }} payments</span>
            <span class="payment-metric__divider">¬∑</span>
            <span class="payment-metric__item">{{ '%.1f'|format((unpaid_amount / total_amount * 100) if total_amount > 0 else 0) }}%</span>
        </div>
    </div>

    <div class="payment-metric payment-metric--neutral">
        <div class="payment-metric__header">
            <span class="payment-metric__icon">üë•</span>
            <span class="payment-metric__label">Models</span>
        </div>
        <div class="payment-metric__value payment-metric__value--compact">{{ models|length }}</div>
        <div class="payment-metric__breakdown">
            <span class="payment-metric__item">USD {{ (total_amount / models|length)|money if models|length > 0 else 0 }} avg</span>
        </div>
    </div>
</section>

<!-- Advanced Filters -->
<section class="card" style="margin-top: 24px;">
    <div class="payment-filter-toolbar">
        <div class="payment-filter-toolbar__search">
            <input type="text" id="quick-search" class="filter-search-input" placeholder="üîç Search by model code, name, notes..." 
                   onkeyup="filterPaymentsTable()">
        </div>
        
        <form class="payment-filter-toolbar__filters" method="get" id="main-filter-form">
            <!-- Date Range Inline -->
            <div class="filter-group-inline filter-group-inline--date">
                <label for="start-date">üìÖ From</label>
                <input id="start-date" name="start_date" type="date" class="filter-date-input" value="{{ filters.start_date or '' }}">
            </div>
            
            <div class="filter-group-inline filter-group-inline--date">
                <label for="end-date">To</label>
                <input id="end-date" name="end_date" type="date" class="filter-date-input" value="{{ filters.end_date or '' }}">
            </div>
            
            <!-- Date Quick Chips -->
            <div class="filter-date-chips" id="payment-quick-ranges">
                <button class="date-chip" type="button" data-range="past_7_days" data-days="7" title="Past 7 days">7d</button>
                <button class="date-chip" type="button" data-range="past_30_days" data-days="30" title="Past 30 days">30d</button>
                <button class="date-chip" type="button" data-range="past_3_months" data-months="3" title="Past 3 months">3m</button>
                <button class="date-chip" type="button" data-range="past_6_months" data-months="6" title="Past 6 months">6m</button>
                <button class="date-chip" type="button" data-range="past_1_year" data-months="12" title="Past year">1y</button>
            </div>
            
            <div class="filter-divider"></div>
            
            <!-- Hidden fields to preserve date range -->
            <input type="hidden" name="start_date" value="{{ filters.start_date }}">
            <input type="hidden" name="end_date" value="{{ filters.end_date }}">
            
            <div class="filter-group-inline">
                <label for="payment_status">Payment Status</label>
                <select id="payment_status" name="payment_status" class="filter-select" onchange="this.form.submit()">
                    <option value="">All</option>
                    {% for option in payment_status_options %}
                        <option value="{{ option }}" {% if filters.payment_status == option %}selected{% endif %}>{{ option|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group-inline">
                <label for="status">Model Status</label>
                <select id="status" name="status" class="filter-select" onchange="this.form.submit()">
                    <option value="">All</option>
                    {% for option in status_options %}
                        <option value="{{ option }}" {% if filters.status == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group-inline">
                <label for="frequency">Frequency</label>
                <select id="frequency" name="frequency" class="filter-select" onchange="this.form.submit()">
                    <option value="">All</option>
                    {% for option in frequency_options %}
                        <option value="{{ option }}" {% if filters.frequency == option %}selected{% endif %}>{{ option|title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group-inline">
                <label for="payment_method">Method</label>
                <select id="payment_method" name="payment_method" class="filter-select" onchange="this.form.submit()">
                    <option value="">All</option>
                    {% for method in payment_methods %}
                        <option value="{{ method }}" {% if filters.payment_method == method %}selected{% endif %}>{{ method }}</option>
                    {% endfor %}
                </select>
            </div>
            
            {% if filters.payment_status or filters.status or filters.frequency or filters.payment_method or filters.start_date or filters.end_date %}
            <a class="filter-clear-button" href="/models/payments">
                <span>‚úï Clear All</span>
            </a>
            {% endif %}
        </form>
    </div>
    
    <div class="filter-toolbar__stats" id="filter-stats">
        <span>Showing <strong id="visible-count">{{ all_payments|length }}</strong> of <strong>{{ all_payments|length }}</strong> payments</span>
    </div>
</section>

<!-- All Payments Table -->
<section class="card" style="margin-top: 24px;">
    <div class="section-heading">
        <div>
            <h2><span class="section-icon">üìä</span> Payment Records</h2>
            <p>Complete payment history across all models</p>
        </div>
    </div>
    
    {% if all_payments %}
    <div class="data-table-wrapper">
        <table class="data-table all-payments-table" id="payments-table">
            <thead>
                <tr>
                    <th>Pay Date</th>
                    <th>Model Code</th>
                    <th>Model Name</th>
                    <th>Amount</th>
                    <th>Frequency</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Cycle</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in all_payments %}
                {% set payout = payment.payout %}
                {% set model = payment.model %}
                {% set run = payment.run %}
                <tr class="payment-row payment-row-{{ payout.status }}" 
                    data-model-code="{{ model.code }}" 
                    data-model-name="{{ model.working_name or '' }}"
                    data-notes="{{ payout.notes or '' }}">
                    <td style="white-space: nowrap;">
                        <strong>{{ payout.pay_date.strftime('%b %d, %Y') if payout.pay_date else '‚Äî' }}</strong>
                    </td>
                    <td>
                        <a href="/models/{{ model.id }}" style="font-weight: 600; color: #60a5fa; text-decoration: none;">
                            {{ model.code }}
                        </a>
                    </td>
                    <td>
                        {{ model.working_name or '‚Äî' }}
                        {% if model.real_name %}
                        <br><small style="color: #94a3b8;">{{ model.real_name }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <strong style="font-size: 15px;">USD {{ payout.amount|money }}</strong>
                    </td>
                    <td>
                        <span class="frequency-badge frequency-badge--{{ payout.payment_frequency }}">
                            {{ payout.payment_frequency|replace('_', ' ')|title if payout.payment_frequency else '‚Äî' }}
                        </span>
                    </td>
                    <td>{{ payout.payment_method or '‚Äî' }}</td>
                    <td>
                        <span class="status-chip status-chip--{{ 'success' if payout.status == 'paid' else ('warning' if payout.status == 'not_paid' else 'neutral') }}">
                            {{ payout.status|replace('_', ' ')|title }}
                        </span>
                    </td>
                    <td>
                        {% if run %}
                        <a href="/schedules/{{ run.id }}" style="color: #60a5fa; text-decoration: none;">
                            Cycle #{{ run.id }}
                        </a>
                        <br><small style="color: #94a3b8;">{{ run.target_year }}-{{ '%02d'|format(run.target_month) }}</small>
                        {% else %}
                        <span style="color: #64748b;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if payout.notes %}
                        <span style="color: #cbd5e1; font-size: 13px;">{{ payout.notes[:50] }}{% if payout.notes|length > 50 %}...{% endif %}</span>
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 6px;">
                            <a href="/models/{{ model.id }}" class="action-button action-button--blue">
                                <span>üë§</span>
                                <span>View Model</span>
                            </a>
                            {% if run %}
                            <a href="/schedules/{{ run.id }}#payment-{{ payout.id }}" class="action-button action-button--purple">
                                <span>üìã</span>
                                <span>View in Cycle</span>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="empty-state">No payment records found matching your filters.</p>
    {% endif %}
</section>

<script>
// Date range quick chip handling
(function() {
    const quickRangeContainer = document.getElementById('payment-quick-ranges');
    const startInput = document.getElementById('start-date');
    const endInput = document.getElementById('end-date');
    const mainForm = document.getElementById('main-filter-form');
    
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function daysInMonth(year, monthIndex) {
        return new Date(year, monthIndex + 1, 0).getDate();
    }
    
    function subtractMonths(date, months) {
        let year = date.getFullYear();
        let monthIndex = date.getMonth() - months;
        const day = date.getDate();
        while (monthIndex < 0) {
            monthIndex += 12;
            year -= 1;
        }
        const maxDay = daysInMonth(year, monthIndex);
        const adjustedDay = Math.min(day, maxDay);
        return new Date(year, monthIndex, adjustedDay);
    }
    
    function clearQuickRangeState() {
        if (!quickRangeContainer) return;
        quickRangeContainer.querySelectorAll('.date-chip').forEach((button) => {
            button.classList.remove('date-chip--active');
        });
    }
    
    function setQuickRange(button) {
        const today = new Date();
        let startDate = null;
        const days = button.getAttribute('data-days');
        const months = button.getAttribute('data-months');
        
        if (days) {
            const dayCount = parseInt(days, 10);
            startDate = new Date(today);
            startDate.setDate(today.getDate() - (dayCount - 1));
        } else if (months) {
            const monthCount = parseInt(months, 10);
            startDate = subtractMonths(today, monthCount);
        }
        
        if (!startDate) return;
        
        startInput.value = formatDate(startDate);
        endInput.value = formatDate(today);
        
        // Mark chip as active
        clearQuickRangeState();
        button.classList.add('date-chip--active');
        
        // Submit form
        mainForm.submit();
    }
    
    if (quickRangeContainer) {
        quickRangeContainer.querySelectorAll('.date-chip').forEach((button) => {
            button.addEventListener('click', () => {
                setQuickRange(button);
            });
        });
    }
    
    // Clear active state when user manually changes dates
    if (startInput) {
        startInput.addEventListener('change', () => {
            clearQuickRangeState();
            if (startInput.value && endInput.value) {
                mainForm.submit();
            }
        });
    }
    if (endInput) {
        endInput.addEventListener('change', () => {
            clearQuickRangeState();
            if (startInput.value && endInput.value) {
                mainForm.submit();
            }
        });
    }
})();

// Filter payments table
function filterPaymentsTable() {
    const searchTerm = document.getElementById('quick-search').value.toLowerCase();
    const table = document.querySelector('#payments-table tbody');
    const rows = table.querySelectorAll('tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const modelCode = row.getAttribute('data-model-code').toLowerCase();
        const modelName = row.getAttribute('data-model-name').toLowerCase();
        const notes = row.getAttribute('data-notes').toLowerCase();
        
        const matchesSearch = !searchTerm || 
            modelCode.includes(searchTerm) || 
            modelName.includes(searchTerm) || 
            notes.includes(searchTerm);
        
        if (matchesSearch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update count
    document.getElementById('visible-count').textContent = visibleCount;
}

// Export to CSV
function exportPaymentsCSV() {
    const params = new URLSearchParams(window.location.search);
    params.set('include_payments', 'true');
    window.location.href = `/models/export?${params.toString()}`;
}
</script>

<style>
/* Date Range Filter */
.payment-date-filter {
    padding: 16px 20px;
    background: rgba(15, 23, 42, 0.5);
    border-radius: 10px;
    border: 1px solid rgba(148, 163, 184, 0.08);
    margin-bottom: 16px;
}

.filter-group-inline--date {
    min-width: 140px;
}

.filter-date-input {
    padding: 10px 12px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 8px;
    font-size: 13px;
    background: rgba(15, 23, 42, 0.6);
    color: #f8fafc;
    transition: all 0.2s ease;
    cursor: pointer;
}

.filter-date-input:hover {
    border-color: rgba(59, 130, 246, 0.5);
    background: rgba(15, 23, 42, 0.8);
}

.filter-date-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.filter-date-chips {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-bottom: 4px;
}

.date-chip {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: rgba(15, 23, 42, 0.5);
    color: #cbd5e1;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.date-chip:hover {
    border-color: rgba(59, 130, 246, 0.5);
    background: rgba(59, 130, 246, 0.15);
    color: #93c5fd;
    transform: translateY(-1px);
}

.date-chip--active {
    border-color: rgba(59, 130, 246, 0.7);
    background: rgba(59, 130, 246, 0.25);
    color: #bfdbfe;
}

.filter-divider {
    width: 1px;
    height: 32px;
    background: rgba(148, 163, 184, 0.2);
    margin: 0 8px;
    align-self: flex-end;
}

/* Payment Metrics Dashboard */
.payment-metrics-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.payment-metric {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s ease;
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35);
}

.payment-metric:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.5);
}

.payment-metric--primary {
    border-left: 4px solid #3b82f6;
    background: linear-gradient(145deg, rgba(30, 64, 175, 0.25), rgba(15, 23, 42, 0.9));
}

.payment-metric--success {
    border-left: 4px solid #22c55e;
    background: linear-gradient(145deg, rgba(34, 197, 94, 0.15), rgba(15, 23, 42, 0.9));
}

.payment-metric--warning {
    border-left: 4px solid #eab308;
    background: linear-gradient(145deg, rgba(234, 179, 8, 0.15), rgba(15, 23, 42, 0.9));
}

.payment-metric--neutral {
    border-left: 4px solid #94a3b8;
}

.payment-metric__header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.payment-metric__icon {
    font-size: 20px;
}

.payment-metric__label {
    font-size: 13px;
    font-weight: 500;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.payment-metric__value {
    font-size: 32px;
    font-weight: 700;
    color: #f8fafc;
    margin-bottom: 8px;
}

.payment-metric__value--compact {
    font-size: 28px;
}

.payment-metric__breakdown {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #94a3b8;
}

.payment-metric__item {
    color: #cbd5e1;
}

.payment-metric__divider {
    color: #475569;
}

/* Payment Filter Toolbar */
.payment-filter-toolbar {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.payment-filter-toolbar__search {
    width: 100%;
}

.filter-search-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 8px;
    font-size: 14px;
    background: rgba(15, 23, 42, 0.6);
    color: #f8fafc;
    transition: all 0.2s ease;
}

.filter-search-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.payment-filter-toolbar__filters {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group-inline {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 160px;
}

.filter-group-inline label {
    font-size: 13px;
    font-weight: 500;
    color: #cbd5e1;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-select {
    padding: 10px 14px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 8px;
    font-size: 14px;
    background: rgba(15, 23, 42, 0.6);
    color: #f8fafc;
    transition: all 0.2s ease;
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.filter-select:hover {
    border-color: rgba(148, 163, 184, 0.5);
}

.filter-clear-button {
    padding: 10px 18px;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    color: #f87171;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
    margin-left: auto;
}

.filter-clear-button:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
    transform: translateY(-1px);
}

.filter-toolbar__stats {
    padding-top: 12px;
    border-top: 1px solid rgba(148, 163, 184, 0.1);
    color: #94a3b8;
    font-size: 14px;
}

.filter-toolbar__stats strong {
    color: #f8fafc;
    font-weight: 600;
}

/* All Payments Table */
.all-payments-table {
    font-size: 14px;
}

.payment-row {
    transition: background-color 0.15s ease;
}

.payment-row:hover {
    background-color: rgba(30, 41, 59, 0.3) !important;
}

.payment-row-paid {
    background: rgba(34, 197, 94, 0.08);
}

.payment-row-not_paid {
    background: rgba(234, 179, 8, 0.08);
}

.payment-row-on_hold {
    background: rgba(239, 68, 68, 0.08);
}

/* Action Buttons */
.action-button {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.action-button--blue {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #60a5fa;
}

.action-button--blue:hover {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-1px);
}

.action-button--purple {
    background: rgba(168, 85, 247, 0.1);
    border: 1px solid rgba(168, 85, 247, 0.3);
    color: #c084fc;
}

.action-button--purple:hover {
    background: rgba(168, 85, 247, 0.2);
    border-color: rgba(168, 85, 247, 0.5);
    transform: translateY(-1px);
}

/* Responsive */
@media (max-width: 1024px) {
    .payment-metrics-dashboard {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .payment-filter-toolbar__filters {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group-inline {
        min-width: 100%;
    }
    
    .filter-clear-button {
        margin-left: 0;
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 640px) {
    .payment-metrics-dashboard {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
