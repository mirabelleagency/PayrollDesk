{% extends "base.html" %}
{% block title %}Model Snapshot · Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">Model Snapshot</h1>
        <p>Preview roster details and upcoming adjustments without leaving the desk.</p>
    </div>
    <div class="header-actions">
        <a class="button secondary" href="/models">Back to Roster</a>
    </div>
</section>

<section class="snapshot-grid">
    <article class="card card--form snapshot-card snapshot-card--primary" aria-labelledby="snapshot-card-heading">
        <header class="card-heading snapshot-heading">
            <div>
                <h2 id="snapshot-card-heading">Snapshot Preview</h2>
                <p>Search the roster and surface key payroll signals instantly.</p>
            </div>
        </header>

        <div class="snapshot-search">
            <label class="sr-only" for="snapshot-combobox">Search models</label>
            <div class="combobox" data-combobox>
                <div class="combobox-control">
                    <span class="combobox-icon" aria-hidden="true">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 4C7.13401 4 4 7.13401 4 11C4 14.866 7.13401 18 11 18C12.8481 18 14.5314 17.2974 15.8242 16.139L19.2929 19.6077C19.6834 19.9982 20.3166 19.9982 20.7071 19.6077C21.0976 19.2172 21.0976 18.584 20.7071 18.1935L17.2383 14.7248C18.3967 13.432 19.0992 11.7486 19.0992 9.90051C19.0992 6.03452 15.9652 2.90051 12.0992 2.90051C8.23318 2.90051 5.09917 6.03452 5.09917 9.90051C5.09917 13.7665 8.23318 16.9005 12.0992 16.9005" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </span>
                    <input id="snapshot-combobox" type="text" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-controls="snapshot-options" aria-describedby="snapshot-hint" autocomplete="off" placeholder="Search by code or working name" />
                    <button type="button" class="combobox-clear" id="snapshot-clear" aria-label="Clear selection">&times;</button>
                </div>
                <ul id="snapshot-options" class="combobox-options" role="listbox" hidden></ul>
                <p class="combobox-hint" id="snapshot-hint">Use Up/Down arrows to browse, Enter to pick a model.</p>
            </div>
        </div>

        <div class="info-grid two-column snapshot-info" id="snapshot-info" hidden>
            <div class="info-field">
                <span class="info-label">Status</span>
                <span class="info-value" data-field="status"></span>
            </div>
            <div class="info-field">
                <span class="info-label">Code</span>
                <span class="info-value" data-field="code"></span>
            </div>
            <div class="info-field">
                <span class="info-label">Real Name</span>
                <span class="info-value" data-field="real_name"></span>
            </div>
            <div class="info-field">
                <span class="info-label">Working Name</span>
                <span class="info-value" data-field="working_name"></span>
            </div>
            <div class="info-field">
                <span class="info-label">Start Date</span>
                <span class="info-value" data-field="start_date"></span>
            </div>
            <div class="info-field">
                <span class="info-label">Payment Method</span>
                <span class="info-value" data-field="payment_method"></span>
            </div>
            <div class="info-field">
                <span class="info-label">Payment Frequency</span>
                <span class="info-value" data-field="payment_frequency"></span>
            </div>
            <div class="info-field">
                <span class="info-label">Monthly Amount (USD)</span>
                <span class="info-value" data-field="amount_monthly"></span>
            </div>
            <div class="info-field span-all">
                <span class="info-label">Crypto Wallet</span>
                <span class="info-value info-value--muted" data-field="crypto_wallet"></span>
            </div>
        </div>

    </article>

    <article class="card card--form snapshot-card snapshot-card--secondary" aria-labelledby="snapshot-adjustments-heading">
        <header class="card-heading snapshot-heading">
            <div>
                <h2 id="snapshot-adjustments-heading">Scheduled Adjustments</h2>
                <p data-field="adjustment-summary">Select a model to see scheduled adjustments.</p>
            </div>
        </header>
        <div class="data-table-wrapper" id="snapshot-adjustments" hidden>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Effective Date</th>
                        <th>Monthly Amount</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <p class="form-hint" id="snapshot-empty">Pick a model to see future raises.</p>
    </article>
</section>

<script type="application/json" id="snapshot-model-data">
[
{% for item in models %}
    {"id": {{ item.id }}, "code": {{ item.code|tojson }}, "working_name": {{ item.working_name|tojson }}, "status": {{ item.status|tojson }}}{% if not loop.last %},{% endif %}
{% endfor %}
]
</script>

<script>
(function () {
    const dataElement = document.getElementById("snapshot-model-data");
    const optionData = dataElement ? JSON.parse(dataElement.textContent || "[]") : [];
    const comboboxInput = document.getElementById("snapshot-combobox");
    const optionList = document.getElementById("snapshot-options");
    const clearButton = document.getElementById("snapshot-clear");
    const infoContainer = document.getElementById("snapshot-info");
    const statsContainer = document.getElementById("snapshot-stats");
    const adjustmentsWrapper = document.getElementById("snapshot-adjustments");
    const adjustmentsBody = adjustmentsWrapper.querySelector("tbody");
    const emptyMessage = document.getElementById("snapshot-empty");
    const fields = Array.from(document.querySelectorAll("[data-field]"))
        .reduce((acc, element) => {
            acc[element.dataset.field] = element;
            return acc;
        }, {});

    if (!comboboxInput) {
        return;
    }

    const defaultSummary = "Select a model to see scheduled adjustments.";
    const defaultEmpty = "Pick a model to see future raises.";
    const currencyFormatter = new Intl.NumberFormat(undefined, {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });

    const infoKeys = [
        "code",
        "real_name",
        "working_name",
        "start_date",
        "payment_method",
        "payment_frequency",
        "amount_monthly",
    ];
    const statKeys = ["total_paid", "adhoc_pending_count", "adhoc_total_count"];

    let filteredOptions = optionData.slice(0, 12);
    let activeIndex = -1;
    let blurTimeout = null;

    function resetView() {
        infoContainer.hidden = true;
        if (statsContainer) {
            statsContainer.hidden = true;
        }
        adjustmentsWrapper.hidden = true;
        adjustmentsBody.innerHTML = "";
        emptyMessage.hidden = false;
        emptyMessage.textContent = defaultEmpty;
        const summaryField = fields["adjustment-summary"];
        if (summaryField) {
            summaryField.textContent = defaultSummary;
        }
        if (fields.status) {
            fields.status.textContent = "—";
        }
        infoKeys.forEach((key) => {
            if (fields[key]) {
                fields[key].textContent = "—";
            }
        });
        statKeys.forEach((key) => {
            if (fields[key]) {
                fields[key].textContent = "—";
            }
        });
        if (fields.crypto_wallet) {
            fields.crypto_wallet.textContent = "Not provided";
            fields.crypto_wallet.classList.add("info-value--muted");
        }
    }

    function setStatus(status) {
        if (!fields.status) {
            return;
        }
        if (!status) {
            fields.status.textContent = "—";
            return;
        }
        const normalized = status.toLowerCase();
        if (normalized === "active") {
            fields.status.innerHTML = '<span class="status-chip status-chip--active">Active</span>';
        } else if (normalized === "inactive") {
            fields.status.innerHTML = '<span class="status-chip status-chip--inactive">Inactive</span>';
        } else {
            fields.status.textContent = status;
        }
    }

    function formatCurrency(amount) {
        const numeric = Number(amount);
        if (!Number.isFinite(numeric)) {
            return "—";
        }
        return currencyFormatter.format(numeric);
    }

    function formatFrequency(value) {
        if (!value) {
            return "—";
        }
        return value.charAt(0).toUpperCase() + value.slice(1);
    }

    function formatNumber(value) {
        if (typeof value !== "number" || Number.isNaN(value)) {
            return "0";
        }
        return value.toString();
    }

    function populateAdjustments(adjustments) {
        adjustmentsBody.innerHTML = "";
        if (!adjustments || adjustments.length === 0) {
            adjustmentsWrapper.hidden = true;
            emptyMessage.hidden = false;
            emptyMessage.textContent = "No compensation adjustments captured yet.";
            if (fields["adjustment-summary"]) {
                fields["adjustment-summary"].textContent = "No scheduled adjustments yet.";
            }
            return;
        }

        adjustmentsWrapper.hidden = false;
        emptyMessage.hidden = true;

        adjustments.forEach((item) => {
            const row = document.createElement("tr");

            const dateCell = document.createElement("td");
            dateCell.textContent = item.effective_date_display || item.effective_date;
            row.appendChild(dateCell);

            const amountCell = document.createElement("td");
            amountCell.classList.add("info-value");
            amountCell.textContent = formatCurrency(item.amount_monthly);
            row.appendChild(amountCell);

            const notesCell = document.createElement("td");
            notesCell.classList.add("info-value--muted");
            notesCell.textContent = item.notes ? item.notes : "—";
            row.appendChild(notesCell);

            adjustmentsBody.appendChild(row);
        });

        const latest = adjustments[adjustments.length - 1];
        if (fields["adjustment-summary"]) {
            fields["adjustment-summary"].textContent = `${adjustments.length} scheduled · latest ${latest.effective_date_display} · ${formatCurrency(latest.amount_monthly)}`;
        }
    }

    async function loadModel(modelId) {
        if (!modelId) {
            resetView();
            return;
        }

        if (fields["adjustment-summary"]) {
            fields["adjustment-summary"].textContent = "Loading model details…";
        }
        emptyMessage.hidden = true;
        adjustmentsWrapper.hidden = true;

        try {
            const response = await fetch(`/models/${modelId}/snapshot.json`, {
                headers: { Accept: "application/json" },
            });
            if (!response.ok) {
                throw new Error(`Request failed with status ${response.status}`);
            }
            const payload = await response.json();
            const model = payload.model || {};
            const adjustments = payload.adjustments || [];
            const stats = payload.stats || {};

            infoContainer.hidden = false;
            if (statsContainer) {
                statsContainer.hidden = false;
            }
            setStatus(model.status);
            infoKeys.forEach((key) => {
                if (!fields[key]) {
                    return;
                }
                switch (key) {
                    case "payment_frequency":
                        fields[key].textContent = formatFrequency(model[key]);
                        break;
                    case "amount_monthly":
                        fields[key].textContent = formatCurrency(model[key]);
                        break;
                    case "start_date":
                        fields[key].textContent = model.start_date_display || "—";
                        break;
                    default:
                        fields[key].textContent = model[key] || "—";
                }
            });

            if (fields.crypto_wallet) {
                if (model.crypto_wallet) {
                    fields.crypto_wallet.textContent = model.crypto_wallet;
                    fields.crypto_wallet.classList.remove("info-value--muted");
                } else {
                    fields.crypto_wallet.textContent = "Not provided";
                    fields.crypto_wallet.classList.add("info-value--muted");
                }
            }

            if (fields.total_paid) {
                fields.total_paid.textContent = stats.total_paid ? formatCurrency(stats.total_paid) : "—";
            }
            if (fields.adhoc_pending_count) {
                fields.adhoc_pending_count.textContent = formatNumber(stats.adhoc_pending_count ?? 0);
            }
            if (fields.adhoc_total_count) {
                fields.adhoc_total_count.textContent = formatNumber(stats.adhoc_total_count ?? 0);
            }

            populateAdjustments(adjustments);
        } catch (error) {
            console.error(error);
            resetView();
            if (fields["adjustment-summary"]) {
                fields["adjustment-summary"].textContent = "Unable to load model details. Try again.";
            }
        }
    }

    function hideOptions() {
        optionList.hidden = true;
        comboboxInput.setAttribute("aria-expanded", "false");
        comboboxInput.removeAttribute("aria-activedescendant");
        activeIndex = -1;
    }

    function renderOptions(options) {
        optionList.innerHTML = "";
        if (!options.length) {
            const emptyItem = document.createElement("li");
            emptyItem.className = "combobox-option combobox-option--empty";
            emptyItem.textContent = "No matches found";
            emptyItem.setAttribute("role", "option");
            emptyItem.setAttribute("aria-disabled", "true");
            optionList.appendChild(emptyItem);
            optionList.hidden = false;
            comboboxInput.setAttribute("aria-expanded", "true");
            return;
        }

        options.forEach((option, index) => {
            const listItem = document.createElement("li");
            listItem.className = "combobox-option";
            listItem.id = `snapshot-option-${option.id}`;
            listItem.setAttribute("role", "option");
            listItem.setAttribute("data-id", option.id);
            listItem.innerHTML = `<span class="combobox-option__code">${option.code}</span><span class="combobox-option__name">${option.working_name}</span>`;
            listItem.addEventListener("mousedown", (event) => {
                event.preventDefault();
                selectOption(index);
            });
            listItem.addEventListener("mouseenter", () => {
                setActiveIndex(index);
            });
            optionList.appendChild(listItem);
        });

        optionList.hidden = false;
        comboboxInput.setAttribute("aria-expanded", "true");
    }

    function setActiveIndex(index) {
        const options = optionList.querySelectorAll(".combobox-option");
        options.forEach((option, idx) => {
            if (idx === index) {
                option.classList.add("combobox-option--active");
            } else {
                option.classList.remove("combobox-option--active");
            }
        });
        if (index >= 0 && options[index]) {
            comboboxInput.setAttribute("aria-activedescendant", options[index].id);
        } else {
            comboboxInput.removeAttribute("aria-activedescendant");
        }
        activeIndex = index;
    }

    function selectOption(index) {
        const option = filteredOptions[index];
        if (!option) {
            return;
        }
        comboboxInput.value = `${option.code} · ${option.working_name}`;
        hideOptions();
        loadModel(option.id);
    }

    function filterOptions(query) {
        const normalized = query.trim().toLowerCase();
        if (!normalized) {
            filteredOptions = optionData.slice(0, 12);
            renderOptions(filteredOptions);
            setActiveIndex(-1);
            return;
        }
        filteredOptions = optionData
            .filter((option) => {
                return (
                    option.code.toLowerCase().includes(normalized) ||
                    option.working_name.toLowerCase().includes(normalized)
                );
            })
            .slice(0, 12);
        renderOptions(filteredOptions);
        setActiveIndex(0);
    }

    comboboxInput.addEventListener("input", (event) => {
        const value = event.target.value;
        filterOptions(value);
    });

    comboboxInput.addEventListener("keydown", (event) => {
        switch (event.key) {
            case "ArrowDown":
                event.preventDefault();
                if (optionList.hidden) {
                    renderOptions(filteredOptions);
                }
                setActiveIndex(Math.min(activeIndex + 1, filteredOptions.length - 1));
                break;
            case "ArrowUp":
                event.preventDefault();
                if (!optionList.hidden) {
                    setActiveIndex(Math.max(activeIndex - 1, 0));
                }
                break;
            case "Enter":
                if (activeIndex >= 0 && !optionList.hidden) {
                    event.preventDefault();
                    selectOption(activeIndex);
                }
                break;
            case "Escape":
                hideOptions();
                break;
            default:
                break;
        }
    });

    comboboxInput.addEventListener("focus", () => {
        if (!comboboxInput.value) {
            filteredOptions = optionData.slice(0, 12);
        }
        renderOptions(filteredOptions);
    });

    comboboxInput.addEventListener("blur", () => {
        blurTimeout = window.setTimeout(() => {
            hideOptions();
        }, 100);
    });

    optionList.addEventListener("mousedown", () => {
        if (blurTimeout) {
            window.clearTimeout(blurTimeout);
        }
    });

    clearButton.addEventListener("click", () => {
        comboboxInput.value = "";
        comboboxInput.focus();
        resetView();
        filteredOptions = optionData.slice(0, 12);
        renderOptions(filteredOptions);
    });

    resetView();
    renderOptions(filteredOptions);
    hideOptions();
})();
</script>
{% endblock %}
